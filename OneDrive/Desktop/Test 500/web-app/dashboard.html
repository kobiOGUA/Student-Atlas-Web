<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kobi's Atlas</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Kobi's Atlas">

    <!-- CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Image Compression Utility -->
    <script src="js/imageCompression.js"></script>

    <!-- Ionicons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>

    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2a2a2a;
            --text-color: #ffffff;
            --text-secondary: #999999;
            --primary-color: #667eea;
            --border-color: #444444;
            --nav-bg: #1a1a1a;
            --modal-bg: #1a1a1a;
        }

        /* Themes */
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --card-bg: #2a2a2a;
            --text-color: #ffffff;
            --text-secondary: #999999;
            --primary-color: #667eea;
            --border-color: #444444;
            --nav-bg: #1a1a1a;
            --modal-bg: #1a1a1a;
        }

        [data-theme="light"] {
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #000000;
            --text-secondary: #666666;
            --primary-color: #667eea;
            --border-color: #dddddd;
            --nav-bg: #ffffff;
            --modal-bg: #ffffff;
        }

        [data-theme="blue"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f8fafc;
            --text-secondary: #94a3b8;
            --primary-color: #3b82f6;
            --border-color: #334155;
            --nav-bg: #0f172a;
            --modal-bg: #1e293b;
        }

        [data-theme="lightPink"] {
            --bg-color: #fff0f5;
            --card-bg: #ffffff;
            --text-color: #4a4a4a;
            --text-secondary: #888888;
            --primary-color: #ff69b4;
            --border-color: #ffc0cb;
            --nav-bg: #ffffff;
            --modal-bg: #ffffff;
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .screen {
            padding: 20px;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 0 0 20px 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 18px;
            margin: 24px 0 12px 0;
            color: var(--text-color);
        }

        .semester-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .course-card {
            background: var(--card-bg);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .course-card:hover {
            background: var(--border-color);
            /* Slightly lighter/darker on hover */
        }

        .modal-content {
            background: var(--modal-bg);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            color: var(--text-color);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 16px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: var(--card-bg);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--nav-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .nav-item ion-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        /* ... keep other styles ... */

        /* Re-add missing styles that might be lost in replacement if not careful */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            margin: -24px -24px 20px -24px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #444;
            transition: 0.3s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
        }

        .ca-score-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .ca-score-input {
            width: 80px;
            text-align: right;
            margin: 0;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10001;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.success {
            background: #28a745;
        }

        .badge {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 8px;
        }

        .badge.pending {
            background: #00d4ff;
        }

        .badge.current {
            background: var(--primary-color);
        }

        .badge.past {
            background: #666;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .nav-badge {
            position: absolute;
            top: 2px;
            right: 14px;
            background: #FF3B30;
            color: white;
            border-radius: 10px;
            min-width: 16px;
            height: 16px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            z-index: 1001;
        }

        /* Add other missing classes */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Reformatted Chat Modal to be full screen ALWAYS */
        .chat-modal-content {
            max-width: 100% !important;
            width: 100% !important;
            height: 100% !important;
            border-radius: 0 !important;
            max-height: none !important;
            margin: 0 !important;
            position: fixed !important;
            top: 0;
            left: 0;
        }

        .day-section {
            margin-bottom: 24px;
        }

        .day-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .schedule-card,
        .task-card {
            background: var(--card-bg);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            gap: 12px;
        }

        .course-code {
            font-size: 12px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .course-name {
            font-size: 16px;
            font-weight: 600;
            margin-top: 2px;
        }

        .time-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .time-text {
            font-size: 14px;
            font-weight: 600;
        }

        .time-line {
            width: 2px;
            flex: 1;
            background: #444;
            margin: 4px 0;
            min-height: 20px;
        }

        .details-container {
            flex: 1;
        }

        .venue-container {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
        }

        .venue-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .checkbox {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        .task-title {
            font-size: 16px;
            color: var(--text-color);
            font-weight: 600;
        }

        .task-date {
            color: var(--text-secondary);
        }

        .delete-task-button {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        .empty-container {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 16px;
        }
    </style>
    <script>
        // Load theme immediately
        const savedTheme = localStorage.getItem('kobi_atlas_theme') || 'default';
        document.documentElement.setAttribute('data-theme', savedTheme);
    </script>
</head>

<body>
    <div id="app">
        <div id="loading-overlay" class="loading hidden">
            <div class="spinner"></div>
        </div>
        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="screen">
            <div class="header" style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <h2 style="margin: 0;">Kobi's Atlas</h2>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;">Academic Overview</p>
                </div>
                <div id="dashboard-widgets" style="text-align: right; font-size: 11px; max-width: 50%;"></div>
            </div>

            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Current CGPA</div>
                    <div class="stat-value" id="cgpa-value">--</div>
                </div>
            </div>

            <div id="current-semester"></div>
            <div id="pending-semesters"></div>
            <div id="past-semesters"></div>

            <button class="fab" onclick="showAddSemesterModal()">+</button>
        </div>

        <!-- Semester Detail Screen -->
        <div id="semester-detail-screen" class="screen hidden">
            <div class="header">
                <button onclick="backToDashboard()"
                    style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">←</button>
                <h2 id="semester-detail-title" style="margin: 10px 0 0 0;"></h2>
                <p id="semester-detail-gpa" style="margin: 5px 0 0 0; opacity: 0.9;"></p>
            </div>

            <div id="courses-list"></div>

            <button class="btn btn-primary" onclick="showAddCourseModal()" style="margin-top: 20px;">+ Add
                Course</button>
            <button class="btn btn-danger" onclick="deleteSemester()" style="margin-top: 10px;">Delete
                Semester</button>
        </div>

        <!-- Course Detail Screen -->
        <div id="course-detail-screen" class="screen hidden">
            <div class="header">
                <button onclick="backToSemester()"
                    style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">←</button>
                <h2 id="course-detail-title" style="margin: 10px 0 0 0;"></h2>
                <p id="course-detail-code" style="margin: 5px 0 0 0; opacity: 0.9;"></p>
            </div>



            <div id="course-info-tab">
                <h3 style="margin-bottom: 16px;">CA Scores</h3>
                <div class="ca-score-row">
                    <span>Mid Semester:</span>
                    <input type="number" id="ca-mid" class="ca-score-input" min="0" max="15"
                        onchange="updateCAScores()">
                </div>
                <div class="ca-score-row">
                    <span>Assignment:</span>
                    <input type="number" id="ca-assignment" class="ca-score-input" min="0" max="10"
                        onchange="updateCAScores()">
                </div>
                <div class="ca-score-row">
                    <span>Quiz:</span>
                    <input type="number" id="ca-quiz" class="ca-score-input" min="0" max="10"
                        onchange="updateCAScores()">
                </div>
                <div class="ca-score-row">
                    <span>Attendance:</span>
                    <input type="number" id="ca-attendance" class="ca-score-input" min="0" max="5"
                        onchange="updateCAScores()">
                </div>
                <div class="ca-score-row" style="border-bottom: 2px solid #667eea;">
                    <span><strong>Total CA:</strong></span>
                    <span id="total-ca" style="font-weight: bold; color: #667eea;">0/40</span>
                </div>

                <h3 style="margin: 24px 0 16px 0;">Exam Target</h3>
                <div class="ca-score-row">
                    <span>Target Grade:</span>
                    <select id="target-grade" onchange="updateExamTarget()" style="width: 100px; margin: 0;">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>
                <div class="ca-score-row">
                    <span>Required Exam Score:</span>
                    <span id="required-exam" style="font-weight: bold; color: #667eea;">--/60</span>
                </div>
                <div class="ca-score-row">
                    <span>Certainty:</span>
                    <span id="certainty" style="font-weight: bold;">--</span>
                </div>

                <h3 style="margin: 24px 0 16px 0;">Course Info</h3>
                <div class="ca-score-row">
                    <span>Unit Hours:</span>
                    <span id="course-units">--</span>
                </div>
                <div class="ca-score-row">
                    <span>Difficulty:</span>
                    <span id="course-difficulty" class="difficulty-stars">★★★☆☆</span>
                </div>

                <button class="btn btn-primary" onclick="saveCourseChanges()" style="margin-top: 24px;">Save
                    Changes</button>
                <button class="btn btn-danger" onclick="deleteCourse()">Delete Course</button>
            </div>


        </div>

        <!-- Planner Screen -->
        <div id="planner-screen" class="screen hidden">
            <div class="header">
                <h2 style="margin: 0;">Planner</h2>
            </div>

            <!-- Tabs -->
            <div class="tab-buttons" style="margin-bottom: 20px;">
                <button class="tab-btn active" id="schedule-tab-btn"
                    onclick="switchPlannerTab('schedule')">Schedule</button>
                <button class="tab-btn" id="tasks-tab-btn" onclick="switchPlannerTab('tasks')">Tasks</button>
            </div>

            <!-- Schedule Tab -->
            <div id="schedule-tab">
                <div id="schedule-content"></div>
                <button class="fab" onclick="showAddScheduleModal()">+</button>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks-tab" class="hidden">
                <div id="tasks-content"></div>
                <button class="fab" onclick="showAddTaskModal()">+</button>
            </div>
        </div>

        <!-- GPA View Screen -->
        <div id="gpa-screen" class="screen hidden">
            <div class="header">
                <h2 style="margin: 0;">GPA Overview</h2>
            </div>

            <!-- Tabs -->
            <div class="tab-buttons" style="margin-bottom: 20px;">
                <button class="tab-btn active" id="gpa-current-tab" onclick="switchGPATab('current')">Current
                    (Real)</button>
                <button class="tab-btn" id="gpa-predicted-tab" onclick="switchGPATab('predicted')">Predicted</button>
            </div>

            <!-- Degree Classification -->
            <div id="classification-card" class="stat-card"
                style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                <ion-icon id="classification-icon" name="star" style="font-size: 36px; color: #FFD700;"></ion-icon>
                <div style="flex: 1;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 4px;">Current Standing</div>
                    <div id="classification-label" style="font-size: 18px; font-weight: bold; color: #FFD700;">
                        First
                        Class</div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 20px;">
                <div class="stat-card">
                    <ion-icon name="school" style="font-size: 32px; color: #667eea; margin-bottom: 8px;"></ion-icon>
                    <div class="stat-value" id="gpa-main-value">--</div>
                    <div class="stat-label" id="gpa-main-label">Cumulative GPA</div>
                </div>
                <div class="stat-card">
                    <ion-icon name="book" style="font-size: 32px; color: #667eea; margin-bottom: 8px;"></ion-icon>
                    <div class="stat-value" id="gpa-credits">--</div>
                    <div class="stat-label">Total Credits</div>
                </div>
                <div class="stat-card">
                    <ion-icon name="calendar" style="font-size: 32px; color: #667eea; margin-bottom: 8px;"></ion-icon>
                    <div class="stat-value" id="gpa-semesters">--</div>
                    <div class="stat-label">Semesters</div>
                </div>
                <div class="stat-card">
                    <ion-icon id="trend-icon" name="remove"
                        style="font-size: 32px; color: #999; margin-bottom: 8px;"></ion-icon>
                    <div class="stat-value" id="trend-value">→</div>
                    <div class="stat-label">Trend</div>
                </div>
            </div>

            <!-- GPA Chart -->
            <div class="stat-card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px;">GPA Trend</h3>
                <div id="gpa-chart"
                    style="display: flex; align-items: flex-end; justify-content: center; gap: 8px; height: 150px; overflow-x: auto;">
                </div>
            </div>

            <!-- Insights -->
            <div class="stat-card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px;">Insights</h3>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <ion-icon name="trophy" style="font-size: 20px; color: #FFD700;"></ion-icon>
                    <span id="best-semester">Best Semester: --</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <ion-icon name="alert-circle" style="font-size: 20px; color: #FF9800;"></ion-icon>
                    <span id="worst-semester">Lowest Semester: --</span>
                </div>
            </div>

            <!-- Grade Distribution -->
            <div id="grade-distribution" class="stat-card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px;">Grade Distribution (Graded Courses)</h3>
                <div id="distribution-content"></div>
            </div>

            <!-- Semester Breakdown -->
            <div class="stat-card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px;">Semester Breakdown</h3>
                <div id="semester-breakdown"></div>
            </div>
        </div>

        <!-- Community Screen -->
        <div id="community-screen" class="screen hidden">
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <h2 style="margin: 0;">Community</h2>
                    <div style="display: flex; gap: 16px; align-items: center;">
                        <button onclick="showUserSearch()" style="background: none; border: none; cursor: pointer;">
                            <ion-icon name="search-outline" style="font-size: 24px; color: white;"></ion-icon>
                        </button>
                        <button onclick="showCreatePostModal()"
                            style="background: none; border: none; cursor: pointer;">
                            <ion-icon name="add-outline" style="font-size: 24px; color: white;"></ion-icon>
                        </button>
                        <button onclick="showNotifications()"
                            style="background: none; border: none; cursor: pointer; position: relative;">
                            <ion-icon name="notifications-outline" style="font-size: 24px; color: white;"></ion-icon>
                            <span id="notification-badge" class="hidden"
                                style="position: absolute; top: -4px; right: -4px; background: #FF3B30; color: white; border-radius: 10px; min-width: 18px; height: 18px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0 4px;">0</span>
                        </button>
                        <button onclick="showProfileSettings()"
                            style="background: none; border: none; cursor: pointer;">
                            <ion-icon name="person-circle-outline" style="font-size: 24px; color: white;"></ion-icon>
                        </button>
                    </div>
                </div>
            </div>

            <div class="tab-buttons" style="margin-bottom: 20px;">
                <button class="tab-btn active" id="comm-feed-tab" onclick="switchCommunityTab('feed')">Feed</button>
                <button class="tab-btn" id="comm-resources-tab"
                    onclick="switchCommunityTab('resources')">Resources</button>
                <button class="tab-btn" id="comm-messages-tab" onclick="switchCommunityTab('messages')">
                    Messages
                    <span id="inner-message-badge" class="badge current hidden"
                        style="margin-left: 8px; font-size: 10px; padding: 2px 6px;">0</span>
                </button>
            </div>

            <div id="community-feed-container">
                <div id="posts-feed"></div>
            </div>

            <div id="community-messages-container" class="hidden">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                    <button class="btn btn-primary" onclick="showUserSearch()"
                        style="width: auto; padding: 8px 16px; font-size: 14px;">
                        <ion-icon name="create-outline" style="margin-right: 5px;"></ion-icon> New Message
                    </button>
                </div>
                <div id="conversations-list"></div>
            </div>

            <div id="community-resources-container" class="hidden">
                <div class="search-bar" style="margin-bottom: 20px;">
                    <input type="text" id="resource-search-input" placeholder="Search resources (code, title)..."
                        oninput="filterResources(this.value)">
                </div>

                <div id="resources-list" style="padding-bottom: 80px;">
                    <!-- Resources will be loaded here -->
                </div>

                <button class="fab" onclick="showResourceUploadModal()">
                    <ion-icon name="add"></ion-icon>
                </button>
            </div>
        </div>

        <!-- Create Post Modal -->
        <div id="create-post-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Create Post</h2>
                    <button class="close-btn" onclick="closeModal('create-post-modal')">&times;</button>
                </div>

                <label>What's on your mind?</label>
                <textarea id="post-content" placeholder="Share something with the community..." rows="4"></textarea>

                <label>Image (Optional)</label>
                <input type="file" id="post-image" accept="image/*"
                    onchange="handleImageUpload(this, 'post-image-preview')">
                <img id="post-image-preview"
                    style="display: none; width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border-radius: 8px;">

                <label>Link (Optional)</label>
                <input type="text" id="post-link" placeholder="https://...">

                <button class="btn btn-primary" onclick="createPost()">Post</button>
                <button class="btn btn-secondary" onclick="closeModal('create-post-modal')">Cancel</button>
            </div>
        </div>

        <!-- Post Detail Modal -->
        <div id="post-detail-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 style="margin: 0;">Post</h2>
                    <button onclick="closeModal('post-detail-modal')"
                        style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                </div>

                <!-- Post Content -->
                <div id="post-detail-content"></div>

                <!-- Reply Input -->
                <div style="margin: 20px 0; padding: 16px; background: #2a2a2a; border-radius: 8px;">
                    <textarea id="reply-input" placeholder="Write a reply..." rows="3"
                        style="margin-bottom: 12px;"></textarea>
                    <button class="btn btn-primary" onclick="createReply()">Reply</button>
                </div>

                <!-- Replies Section -->
                <div>
                    <h3 style="margin-bottom: 16px;">Replies (<span id="replies-count">0</span>)</h3>
                    <div id="replies-list"></div>
                </div>
            </div>
        </div>

        <!-- User Search Modal -->
        <div id="user-search-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Search Users</h2>
                    <button onclick="closeModal('user-search-modal')"
                        style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                </div>

                <input type="text" id="user-search-input" placeholder="Search by username or email..."
                    style="margin-bottom: 20px;" oninput="searchUsers()">

                <div id="users-list"></div>
            </div>
        </div>

        <!-- User Profile Modal -->
        <div id="user-profile-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Profile</h2>
                    <button onclick="closeModal('user-profile-modal')"
                        style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                </div>

                <div id="user-profile-content"></div>
            </div>
        </div>

        <!-- Notifications Modal -->
        <div id="notifications-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Notifications</h2>
                    <button onclick="closeModal('notifications-modal')"
                        style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                </div>

                <div id="notifications-list"></div>
            </div>
        </div>

        <!-- Chat Modal -->
        <div id="chat-modal" class="modal">
            <div class="modal-content chat-modal-content"
                style="display: flex; flex-direction: column; height: 95vh; padding: 0;">
                <div class="modal-header" style="margin: 0; padding: 16px; border-radius: 12px 12px 0 0;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <ion-icon name="arrow-back" style="font-size: 24px; cursor: pointer;"
                            onclick="closeModal('chat-modal')"></ion-icon>
                        <h2 style="margin: 0; font-size: 18px;" id="chat-username">Chat</h2>
                    </div>
                </div>

                <div id="messages-list"
                    style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px;">
                </div>

                <div
                    style="padding: 12px; background: var(--modal-bg); border-top: 1px solid var(--border-color); display: flex; gap: 10px; border-radius: 0 0 12px 12px;">
                    <input type="text" id="message-input" placeholder="Type a message..."
                        style="flex: 1; margin: 0; border-radius: 20px;"
                        onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="btn btn-primary"
                        style="width: auto; margin: 0; padding: 0 20px; border-radius: 20px;" onclick="sendMessage()">
                        <ion-icon name="send"></ion-icon>
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Settings Modal -->
        <div id="profile-settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Edit Profile</h2>
                    <button onclick="closeModal('profile-settings-modal')"
                        style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                </div>

                <label>Profile Picture</label>
                <input type="file" id="profile-picture-input" accept="image/*"
                    onchange="handleImageUpload(this, 'profile-picture-preview')">
                <img id="profile-picture-preview"
                    style="display: none; width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px 0;">

                <label>Username</label>
                <input type="text" id="profile-username" placeholder="Username">

                <label>Bio</label>
                <textarea id="profile-bio" placeholder="Tell us about yourself..." rows="3"></textarea>

                <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
                <button class="btn btn-secondary" onclick="closeModal('profile-settings-modal')">Cancel</button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Settings</h2>
                    <button onclick="closeModal('settings-modal')"
                        style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="margin: 0 0 12px 0; color: #999; font-size: 14px; text-transform: uppercase;">
                        Account
                    </h3>
                    <button class="btn btn-primary"
                        style="width: 100%; margin-bottom: 10px; justify-content: flex-start;"
                        onclick="closeModal('settings-modal'); document.getElementById('profile-settings-modal').classList.add('show');">
                        <ion-icon name="person-outline" style="margin-right: 8px;"></ion-icon>
                        Edit Profile
                    </button>
                    <button class="btn btn-primary"
                        style="width: 100%; margin-bottom: 10px; justify-content: flex-start;"
                        onclick="window.location.href='change-pin.html'">
                        <ion-icon name="key-outline" style="margin-right: 8px;"></ion-icon>
                        Change PIN
                    </button>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="margin: 0 0 12px 0; color: #999; font-size: 14px; text-transform: uppercase;">
                        About</h3>
                    <div style="padding: 16px; background: #2a2a2a; border-radius: 8px;">
                        <h4 style="margin: 0 0 8px 0; color: white;">Kobi's Atlas</h4>
                        <p style="margin: 4px 0; color: #999; font-size: 14px;">Version 1.0.0</p>
                        <p style="margin: 4px 0; color: #999; font-size: 14px;">By Kobi Oguadinma</p>
                        <p style="margin: 4px 0; color: #999; font-size: 14px;">Babcock University</p>
                        <p style="margin: 12px 0 0 0; color: #ccc; font-size: 13px; line-height: 1.5;">An
                            academic
                            companion for tracking courses, calculating GPA, and predicting grades.</p>
                        <p
                            style="margin: 12px 0 0 0; color: #ccc; font-size: 13px; line-height: 1.5; font-style: italic;">
                            Kobi's Atlas was an individual project by Kobi Oguadinma, a second-year Software
                            Engineering student at Babcock University. He frequently calculated his predicted
                            grades
                            manually and wanted a mobile app to automate this process.</p>
                        <p style="margin: 12px 0 0 0; color: #ff9800; font-size: 12px; font-style: italic;">
                            Currently
                            supports Babcock University grading system. Other systems will be available in
                            future
                            updates.</p>
                    </div>
                </div>

                <button class="btn" style="width: 100%; background: #dc3545; color: white;" onclick="logout()">
                    <ion-icon name="log-out-outline" style="margin-right: 8px;"></ion-icon>
                    Logout
                </button>
            </div>
        </div>

        <!-- Change PIN Modal -->
        <div id="change-pin-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Change PIN</h2>
                    <button onclick="closeModal('change-pin-modal')"
                        style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                </div>

                <label>Current PIN</label>
                <input type="password" id="current-pin" placeholder="Enter current PIN" maxlength="4" pattern="[0-9]*"
                    inputmode="numeric">

                <label>New PIN</label>
                <input type="password" id="new-pin" placeholder="Enter new PIN (4 digits)" maxlength="4"
                    pattern="[0-9]*" inputmode="numeric">

                <label>Confirm New PIN</label>
                <input type="password" id="confirm-pin" placeholder="Confirm new PIN" maxlength="4" pattern="[0-9]*"
                    inputmode="numeric">

                <button class="btn btn-primary" onclick="changePIN()">Change PIN</button>
                <button class="btn btn-secondary" onclick="closeModal('change-pin-modal')">Cancel</button>
            </div>
        </div>

        <!-- Add Schedule Modal -->
        <div id="add-schedule-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Add Schedule</h2>
                    <button class="close-btn" onclick="closeModal('add-schedule-modal')">&times;</button>
                </div>

                <label>Title (Optional if Course selected)</label>
                <input type="text" id="schedule-title" placeholder="Event Title or Course Name">

                <label>Course (Optional)</label>
                <select id="schedule-course-select">
                    <option value="">No Course / Personal</option>
                </select>

                <div style="display: flex; align-items: center; justify-content: space-between; margin: 12px 0;">
                    <label style="margin: 0;">Recurring Event?</label>
                    <label class="switch">
                        <input type="checkbox" id="schedule-recurring" checked onchange="toggleScheduleDateInput()">
                        <span class="slider round"></span>
                    </label>
                </div>

                <div id="schedule-day-container">
                    <label>Day</label>
                    <select id="schedule-day">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>

                <div id="schedule-date-container" class="hidden">
                    <label>Date</label>
                    <input type="date" id="schedule-date">
                </div>

                <label>Start Time</label>
                <input type="time" id="schedule-start-time" value="08:00">

                <label>End Time</label>
                <input type="time" id="schedule-end-time" value="09:00">

                <label>Venue (Optional)</label>
                <input type="text" id="schedule-venue" placeholder="e.g., LT1, Lab 3">

                <input type="hidden" id="edit-schedule-id">
                <input type="hidden" id="edit-schedule-course-id">
                <input type="hidden" id="edit-schedule-original-start">

                <button class="btn btn-primary" onclick="saveScheduleV2()">Save Schedule</button>
                <button class="btn btn-secondary" onclick="closeModal('add-schedule-modal')">Cancel</button>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div id="add-task-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Add Task</h2>
                    <button class="close-btn" onclick="closeModal('add-task-modal')">&times;</button>
                </div>

                <label>Task Title</label>
                <input type="text" id="task-title" placeholder="e.g., Complete Assignment 1">
                <input type="hidden" id="task-id">

                <label>Course (Optional)</label>
                <select id="task-course-select">
                    <option value="">None</option>
                </select>

                <label>Type</label>
                <select id="task-type">
                    <option value="assignment">Assignment</option>
                    <option value="exam">Exam</option>
                    <option value="study">Study</option>
                    <option value="other">Other</option>
                </select>

                <label>Due Date</label>
                <input type="date" id="task-due-date">

                <label>Description (Optional)</label>
                <textarea id="task-description" placeholder="Add details..." rows="3"></textarea>

                <button class="btn btn-primary" onclick="addTask()">Add Task</button>
                <button class="btn btn-secondary" onclick="closeModal('add-task-modal')">Cancel</button>
            </div>
        </div>

        <!-- Add Semester Modal -->
        <div id="add-semester-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Add Semester</h2>
                    <button class="close-btn" onclick="closeModal('add-semester-modal')">&times;</button>
                </div>

                <label>Entry Method</label>
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchEntryMethod('manual')">Manual Course
                        Entry</button>
                    <button class="tab-btn" onclick="switchEntryMethod('quick')">Quick Add (GPA)</button>
                </div>

                <div id="manual-entry">
                    <label>Semester Name</label>
                    <input type="text" id="semester-name" placeholder="e.g., 200 Level 1st Semester">

                    <label>Semester Type</label>
                    <div class="tab-buttons">
                        <button class="tab-btn active" id="type-current"
                            onclick="selectType('current')">Current</button>
                        <button class="tab-btn" id="type-pending" onclick="selectType('pending')">Pending</button>
                        <button class="tab-btn" id="type-past" onclick="selectType('past')">Past</button>
                    </div>

                    <button class="btn btn-primary" onclick="createSemester()">Create Semester</button>
                    <button class="btn btn-secondary" onclick="closeModal('add-semester-modal')">Cancel</button>
                </div>

                <div id="quick-entry" class="hidden">
                    <label>Semester Name</label>
                    <input type="text" id="quick-semester-name" placeholder="e.g., 100 Level">

                    <label>GPA</label>
                    <input type="number" id="quick-gpa" placeholder="0.00 - 5.00" step="0.01">

                    <label>Total Units</label>
                    <input type="number" id="quick-units" placeholder="Total units taken">

                    <button class="btn btn-primary" onclick="createQuickSemester()">Create Semester</button>
                    <button class="btn btn-secondary" onclick="closeModal('add-semester-modal')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Course Modal -->
        <div id="add-course-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">Add Course</h2>
                    <button class="close-btn" onclick="closeModal('add-course-modal')">&times;</button>
                </div>

                <label>Course Title</label>
                <input type="text" id="course-title" placeholder="e.g., Discrete Structures">

                <label>Course Code</label>
                <input type="text" id="course-code" placeholder="e.g., CSC203">

                <label>Unit Hours</label>
                <input type="number" id="course-unit-hours" placeholder="e.g., 2" min="1" max="6">

                <label>Target Grade</label>
                <select id="course-target-grade">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>

                <label>Difficulty (1-5)</label>
                <select id="course-difficulty-select">
                    <option value="1">1 - Very Easy</option>
                    <option value="2">2 - Easy</option>
                    <option value="3" selected>3 - Medium</option>
                    <option value="4">4 - Hard</option>
                    <option value="5">5 - Very Hard</option>
                </select>

                <button class="btn btn-primary" onclick="addCourse()">Add Course</button>
                <button class="btn btn-secondary" onclick="closeModal('add-course-modal')">Cancel</button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showScreen('dashboard')">
                <ion-icon name="home"></ion-icon>
                <span style="font-size: 11px;">Home</span>
            </button>
            <button class="nav-item" onclick="showScreen('planner')">
                <ion-icon name="calendar"></ion-icon>
                <span style="font-size: 11px;">Planner</span>
            </button>
            <button class="nav-item" onclick="showScreen('gpa')">
                <ion-icon name="stats-chart"></ion-icon>
                <span style="font-size: 11px;">GPA</span>
            </button>
            <button class="nav-item" onclick="showScreen('community')" style="position: relative;">
                <ion-icon name="people"></ion-icon>
                <span style="font-size: 11px;">Community</span>
                <span id="nav-community-badge" class="nav-badge hidden">0</span>
            </button>
            <button class="nav-item" onclick="window.location.href='settings.html'">
                <ion-icon name="settings"></ion-icon>
                <span style="font-size: 11px;">Settings</span>
            </button>
        </div>

    </div>

    <div id="toast-container"></div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, doc, setDoc, addDoc, updateDoc, getDoc, deleteDoc, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBKA2julrxpRhXTdU_8l5pSH73ERAjKtO4",
            authDomain: "kobi-s-student-atlas.firebaseapp.com",
            projectId: "kobi-s-student-atlas",
            storageBucket: "kobi-s-student-atlas.firebasestorage.app",
            messagingSenderId: "955486974004",
            appId: "1:955486974004:web:be7d825c279d2e263c5a61"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentSemester = null;
        let currentCourse = null;
        let selectedSemesterType = 'current';
        let entryMethod = 'manual';
        let currentChatUser = null;
        let currentViewingUser = null;

        // Badge counting logic (Real-time)
        let notifUnsubscribe = null;
        let msgUnsubscribe = null;
        let friendReqUnsubscribe = null;

        window.startRealtimeListeners = function () {
            const uid = localStorage.getItem('kobi_atlas_uid');
            if (!uid) return;

            // Stop existing listeners if any
            if (notifUnsubscribe) notifUnsubscribe();
            if (msgUnsubscribe) msgUnsubscribe();
            if (friendReqUnsubscribe) friendReqUnsubscribe();

            try {
                // Notifications Listener
                const notifRef = collection(db, 'notifications');
                const notifQuery = query(notifRef, where('userId', '==', uid), where('read', '==', false));
                notifUnsubscribe = onSnapshot(notifQuery, (snapshot) => {
                    const notifCount = snapshot.size;
                    updateBadgeCounts(notifCount, null, null);
                });

                // Pending Friend Requests Listener
                const friendReqRef = collection(db, 'friendRequests');
                const friendReqQuery = query(friendReqRef, where('toUserId', '==', uid), where('status', '==', 'pending'));
                friendReqUnsubscribe = onSnapshot(friendReqQuery, (snapshot) => {
                    const friendReqCount = snapshot.size;
                    updateBadgeCounts(null, friendReqCount, null);
                });

                // Messages Listener
                const msgRef = collection(db, 'messages');
                const msgQuery = query(msgRef, where('receiverId', '==', uid), where('read', '==', false));
                msgUnsubscribe = onSnapshot(msgQuery, (snapshot) => {
                    const msgCount = snapshot.size;
                    updateBadgeCounts(null, null, msgCount);
                });

            } catch (error) {
                console.error('Error starting listeners:', error);
            }
        };

        let currentNotifCount = 0;
        let currentFriendReqCount = 0;
        let currentMsgCount = 0;

        function updateBadgeCounts(notifCount, friendReqCount, msgCount) {
            if (notifCount !== null) currentNotifCount = notifCount;
            if (friendReqCount !== null) currentFriendReqCount = friendReqCount;
            if (msgCount !== null) currentMsgCount = msgCount;

            // Community badge sums everything (notifs + requests + messages)
            const totalCommunityCount = currentNotifCount + currentFriendReqCount + currentMsgCount;

            updateBadge('nav-community-badge', totalCommunityCount);
            updateBadge('inner-message-badge', currentMsgCount);
            updateBadge('notification-badge', currentNotifCount + currentFriendReqCount);
        }

        window.loadUnreadCounts = function () {
            // Wrapper for backward compatibility if called elsewhere
            // Real-time listeners handle updates automatically
            startRealtimeListeners();
        };

        function updateBadge(elementId, count) {
            const badge = document.getElementById(elementId);
            if (badge) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.toggle('hidden', count === 0);
            }
        }

        // Initialize immediately if user exists
        if (localStorage.getItem('kobi_atlas_uid')) {
            startRealtimeListeners();
        }

        // Utility functions
        function showLoading(show) {
            const loader = document.getElementById('loading-overlay');
            if (loader) {
                if (show) loader.classList.remove('hidden');
                else loader.classList.add('hidden');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        window.showScreen = function (screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));

            // Show target screen
            // Handle both "dashboard" and "dashboard-screen" formats
            const targetId = screenId.endsWith('-screen') ? screenId : `${screenId}-screen`;
            const screen = document.getElementById(targetId);

            if (screen) {
                screen.classList.remove('hidden');
            } else {
                console.warn(`Screen not found: ${screenId}`);
            }

            // Update bottom nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            // This is a simple heuristic; might need adjustment if nav onclicks change
            const navItem = Array.from(document.querySelectorAll('.nav-item')).find(item =>
                item.getAttribute('onclick')?.includes(`'${screenId}'`)
            );
            if (navItem) navItem.classList.add('active');

            window.scrollTo(0, 0);
        };

        window.closeModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
            }
        };

        const OWNER_EMAILS = ['kobioguadinma@gmail.com'];
        const ACHIEVEMENTS = [
            { id: 'first_semester', title: 'Freshman', description: 'Completed your first semester', icon: 'school' },
            { id: 'first_class', title: "First Class", description: 'Achieved a CGPA of 4.5 or higher', icon: 'ribbon' },
            { id: 'socialite', title: 'Social Butterfly', description: 'Added 5 friends', icon: 'people' },
            { id: 'scholar', title: 'Scholar', description: 'Added 10 courses', icon: 'book' },
            { id: 'planner', title: 'Organized', description: 'Created 5 tasks', icon: 'calendar' },
            { id: 'contributor', title: 'Contributor', description: 'Shared a resource', icon: 'share' },
        ];
        function isOwner(user) {
            if (!user || !user.email) return false;
            return OWNER_EMAILS.includes(user.email);
        }

        function gradeToPoint(grade) {
            const points = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'E': 1, 'F': 0 };
            return points[grade] || 0;
        }

        function calculateSemesterGPA(courses) {
            if (!courses || courses.length === 0) return 0;
            let totalPoints = 0;
            let totalUnits = 0;

            courses.forEach(course => {
                const grade = course.grade || course.predictedGrade || course.targetGrade;
                if (grade) {
                    const points = gradeToPoint(grade);
                    const units = course.unitHours || 0;
                    totalPoints += points * units;
                    totalUnits += units;
                }
            });

            return totalUnits === 0 ? 0 : (totalPoints / totalUnits).toFixed(2);
        }

        function calculateRequiredExam(caTotal, targetGrade) {
            const targets = { 'A': 70, 'B': 60, 'C': 50 };
            const required = (targets[targetGrade] || 70) - caTotal;
            return Math.max(0, Math.min(60, required));
        }

        function getCertainty(required) {
            if (required <= 30) return 'High';
            if (required <= 45) return 'Medium';
            return 'Low';
        }

        function getDifficultyStars(difficulty) {
            const filled = '★'.repeat(difficulty);
            const empty = '☆'.repeat(5 - difficulty);
            return filled + empty;
        }

        // Dashboard functions
        async function loadDashboard() {
            const uid = localStorage.getItem('kobi_atlas_uid');
            if (!uid) {
                window.location.href = 'index.html';
                return;
            }

            showLoading(true);

            try {
                // Ensure anonymous authentication for Firestore access
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);

                const semesters = [];
                snapshot.forEach(doc => {
                    semesters.push({ id: doc.id, ...doc.data() });
                });

                // Separate by type
                const pending = semesters.filter(s => s.type === 'pending');
                const current = semesters.filter(s => s.type === 'current');
                const past = semesters.filter(s => s.type === 'past');

                const currentSemester = current[0];
                const hasPredicted = currentSemester || pending.length > 0;

                // Calculate CGPAs
                let totalPoints = 0;
                let totalUnits = 0;
                let predictedPoints = 0;
                let predictedUnits = 0;

                semesters.forEach(sem => {
                    if (sem.type === 'past' && sem.gpa && sem.totalUnits) {
                        totalPoints += sem.gpa * sem.totalUnits;
                        totalUnits += sem.totalUnits;
                        predictedPoints += sem.gpa * sem.totalUnits;
                        predictedUnits += sem.totalUnits;
                    } else if (sem.courses) {
                        const semGPA = parseFloat(calculateSemesterGPA(sem.courses));
                        const semUnits = sem.courses.reduce((sum, c) => sum + (c.unitHours || 0), 0);

                        if (sem.type === 'past') {
                            totalPoints += semGPA * semUnits;
                            totalUnits += semUnits;
                        }

                        predictedPoints += semGPA * semUnits;
                        predictedUnits += semUnits;
                    }
                });

                const cgpa = totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : '0.00';
                const predictedCGPA = predictedUnits > 0 ? (predictedPoints / predictedUnits).toFixed(2) : '0.00';

                // Display stats - FIXED: Only show predicted if current/pending exists
                const statsGrid = document.getElementById('stats-grid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Current CGPA</div>
                        <div class="stat-value">${cgpa}</div>
                    </div>
                    ${hasPredicted ? `
                        <div class="stat-card">
                            <div class="stat-label">Predicted CGPA</div>
                            <div class="stat-value">${predictedCGPA}</div>
                        </div>
                    ` : ''}
                `;

                // Display semesters by type (Current first as requested)
                displaySemesterSection('current-semester', 'Current Semester', current, 'current');
                displaySemesterSection('pending-semesters', 'Pending Semesters', pending, 'pending');
                displaySemesterSection('past-semesters', 'Past Semesters', past, 'past');

            } catch (error) {
                console.error('Load dashboard error:', error);
                showToast('Error loading dashboard', 'error');
            }

            loadUnreadCounts();
            if (window.loadDashboardWidgets) window.loadDashboardWidgets();
            showLoading(false);
        }

        function displaySemesterSection(containerId, title, semesters, type) {
            const container = document.getElementById(containerId);

            if (semesters.length === 0) {
                container.innerHTML = '';
                return;
            }

            const html = `
                <div class="section-title">${title}</div>
                ${semesters.map(sem => {
                const gpa = sem.gpa || calculateSemesterGPA(sem.courses || []);
                const courseCount = sem.courses?.length || 0;
                return `
                        <div class="semester-card ${type}" onclick="viewSemester('${sem.id}')" style="position: relative;">
                            <span class="badge ${type}">${type.toUpperCase()}</span>
                            ${type === 'pending' ? `
                                <button onclick="event.stopPropagation(); showEndSemesterModal('${sem.id}')" style="position: absolute; bottom: 10px; right: 10px; background: #667eea; color: white; border: none; borderRadius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; z-index: 10;">
                                    Enter Grades
                                </button>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold; font-size: 16px;">${sem.name}</div>
                                    <div style="font-size: 14px; color: #999; margin-top: 4px;">${courseCount} courses</div>
                                </div>
                                <div style="text-align: right; padding-bottom: ${type === 'pending' ? '20px' : '0'};">
                                    <div style="font-size: 20px; font-weight: bold; color: #667eea;">
                                        ${type === 'pending' || type === 'current' ? 'Predicted' : 'GPA'}: ${parseFloat(gpa).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
            }).join('')}
            `;

            container.innerHTML = html;
        }

        // Semester detail functions
        window.viewSemester = async function (semesterId) {
            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const semDoc = await getDoc(doc(db, 'users', uid, 'semesters', semesterId));
                if (!semDoc.exists()) {
                    showToast('Semester not found', 'error');
                    return;
                }

                currentSemester = { id: semDoc.id, ...semDoc.data() };

                document.getElementById('semester-detail-title').textContent = currentSemester.name;
                const gpa = currentSemester.gpa || calculateSemesterGPA(currentSemester.courses || []);
                document.getElementById('semester-detail-gpa').textContent = `GPA: ${parseFloat(gpa).toFixed(2)}`;

                const courses = currentSemester.courses || [];
                const coursesHTML = courses.length > 0 ? courses.map((course, index) => {
                    const grade = course.grade || course.predictedGrade || course.targetGrade || '--';
                    const stars = getDifficultyStars(course.difficulty || 3);
                    return `
                        <div class="course-card" onclick="viewCourse(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold;">${course.name}</div>
                                    <div style="font-size: 12px; color: #999;">${course.code}</div>
                                    <div style="font-size: 12px; color: #999; margin-top: 4px;">
                                        ${course.unitHours} units • Target: ${course.targetGrade} • Grade: ${grade}
                                    </div>
                                    <div class="difficulty-stars" style="margin-top: 4px;">${stars}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : '<p style="text-align: center; color: #999; padding: 40px;">No courses yet</p>';

                document.getElementById('courses-list').innerHTML = coursesHTML;

                showScreen('semester-detail');
            } catch (error) {
                console.error('View semester error:', error);
                showToast('Error loading semester', 'error');
            }

            showLoading(false);
        };

        // Course detail functions
        window.viewCourse = function (courseIndex) {
            currentCourse = { ...currentSemester.courses[courseIndex], index: courseIndex };

            document.getElementById('course-detail-title').textContent = currentCourse.name;
            document.getElementById('course-detail-code').textContent = currentCourse.code;

            // Load CA scores
            const ca = currentCourse.caScores || {};
            document.getElementById('ca-mid').value = ca.midSemester || 0;
            document.getElementById('ca-assignment').value = ca.assignment || 0;
            document.getElementById('ca-quiz').value = ca.quiz || 0;
            document.getElementById('ca-attendance').value = ca.attendance || 0;

            document.getElementById('target-grade').value = currentCourse.targetGrade || 'A';
            document.getElementById('course-units').textContent = currentCourse.unitHours || 0;
            document.getElementById('course-difficulty').textContent = getDifficultyStars(currentCourse.difficulty || 3);

            updateCAScores();
            showScreen('course-detail');
        };

        window.updateCAScores = function () {
            const mid = parseInt(document.getElementById('ca-mid').value) || 0;
            const assignment = parseInt(document.getElementById('ca-assignment').value) || 0;
            const quiz = parseInt(document.getElementById('ca-quiz').value) || 0;
            const attendance = parseInt(document.getElementById('ca-attendance').value) || 0;

            const total = mid + assignment + quiz + attendance;
            document.getElementById('total-ca').textContent = `${total}/40`;

            updateExamTarget();
        };

        window.updateExamTarget = function () {
            const targetGrade = document.getElementById('target-grade').value;
            const totalCA = parseInt(document.getElementById('total-ca').textContent.split('/')[0]) || 0;

            const required = calculateRequiredExam(totalCA, targetGrade);
            const certainty = getCertainty(required);

            document.getElementById('required-exam').textContent = `${required.toFixed(0)}/60`;
            document.getElementById('certainty').textContent = certainty;
            document.getElementById('certainty').style.color =
                certainty === 'High' ? '#28a745' : certainty === 'Medium' ? '#ffc107' : '#dc3545';
        };

        window.saveCourseChanges = async function () {
            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const caScores = {
                    midSemester: parseInt(document.getElementById('ca-mid').value) || 0,
                    assignment: parseInt(document.getElementById('ca-assignment').value) || 0,
                    quiz: parseInt(document.getElementById('ca-quiz').value) || 0,
                    attendance: parseInt(document.getElementById('ca-attendance').value) || 0
                };

                const targetGrade = document.getElementById('target-grade').value;

                // Update course in semester
                currentSemester.courses[currentCourse.index].caScores = caScores;
                currentSemester.courses[currentCourse.index].targetGrade = targetGrade;

                // Calculate predicted grade based on CA + target
                const totalCA = Object.values(caScores).reduce((a, b) => a + b, 0);
                const requiredExam = calculateRequiredExam(totalCA, targetGrade);
                const predictedTotal = totalCA + Math.min(requiredExam, 60);

                let predictedGrade = 'F';
                if (predictedTotal >= 70) predictedGrade = 'A';
                else if (predictedTotal >= 60) predictedGrade = 'B';
                else if (predictedTotal >= 50) predictedGrade = 'C';
                else if (predictedTotal >= 45) predictedGrade = 'D';
                else if (predictedTotal >= 40) predictedGrade = 'E';

                currentSemester.courses[currentCourse.index].predictedGrade = predictedGrade;

                // Recalculate semester GPA
                const semesterGPA = parseFloat(calculateSemesterGPA(currentSemester.courses));
                const totalUnits = currentSemester.courses.reduce((sum, c) => sum + (c.unitHours || 0), 0);

                await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                    courses: currentSemester.courses,
                    gpa: semesterGPA,
                    totalUnits: totalUnits
                });

                showToast('Course updated successfully', 'success');
                backToSemester();
            } catch (error) {
                console.error('Save course error:', error);
                showToast('Error saving course', 'error');
            }

            showLoading(false);
        };

        window.deleteCourse = async function () {
            if (!confirm('Delete this course?')) return;

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                currentSemester.courses.splice(currentCourse.index, 1);

                // Recalculate semester GPA
                const semesterGPA = parseFloat(calculateSemesterGPA(currentSemester.courses));
                const totalUnits = currentSemester.courses.reduce((sum, c) => sum + (c.unitHours || 0), 0);

                await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                    courses: currentSemester.courses,
                    gpa: semesterGPA,
                    totalUnits: totalUnits
                });

                showToast('Course deleted', 'success');
                backToSemester();
            } catch (error) {
                console.error('Delete course error:', error);
                showToast('Error deleting course', 'error');
            }

            showLoading(false);
        };

        // RESOURCE FUNCTIONS
        window.loadResources = async function () {
            if (!currentCourse || !currentCourse.code) return;

            const normalizedCode = currentCourse.code.replace(/\s/g, '').toUpperCase();
            const container = document.getElementById('resources-list-container');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><ion-icon name="sync" class="spin" style="font-size: 24px; color: var(--primary-color);"></ion-icon></div>';

            try {
                const q = query(collection(db, 'resources'), where('courseCode', '==', normalizedCode));
                const snapshot = await getDocs(q);
                let resources = [];
                snapshot.forEach(doc => resources.push({ id: doc.id, ...doc.data() }));

                // Sort by votes desc
                resources.sort((a, b) => b.votes - a.votes);

                if (resources.length === 0) {
                    container.innerHTML = `
                        <div class="empty-container" style="text-align: center; padding: 20px;">
                            <ion-icon name="folder-open-outline" style="font-size: 48px; color: var(--text-secondary); display: block; margin: 0 auto;"></ion-icon>
                            <p style="color: var(--text-secondary); margin-top: 10px;">No resources yet.</p>
                            <p style="color: var(--text-secondary); font-size: 14px;">Be the first to share notes or past questions!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = resources.map(res => {
                    const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(res.link);
                    const actionText = isImage ? 'View Image' : 'Download';
                    const iconName = isImage ? 'image-outline' : 'download-outline';
                    const downloadAttr = isImage ? '' : 'download';

                    return `
                    <div class="stat-card" style="margin-bottom: 12px; text-align: left;">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="flex: 1;">
                                <a href="${res.link}" target="_blank" ${downloadAttr} style="text-decoration: none; color: inherit;">
                                    <div style="font-weight: bold; font-size: 16px; color: var(--primary-color); margin-bottom: 4px;">${res.title}</div>
                                    ${res.description ? `<div style="font-size: 14px; margin-bottom: 6px;">${res.description}</div>` : ''}
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        By ${res.uploadedByName} • ${new Date(res.timestamp).toLocaleDateString()}
                                    </div>
                                </a>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; margin-left: 10px;">
                                <button onclick="voteResource('${res.id}', 1)" style="background: none; border: none; cursor: pointer;">
                                    <ion-icon name="caret-up" style="font-size: 24px; color: var(--text-color);"></ion-icon>
                                </button>
                                <span style="font-weight: bold; font-size: 14px; color: var(--primary-color);">${res.votes}</span>
                                <button onclick="voteResource('${res.id}', -1)" style="background: none; border: none; cursor: pointer;">
                                    <ion-icon name="caret-down" style="font-size: 24px; color: var(--text-color);"></ion-icon>
                                </button>
                            </div>
                        </div>
                        <a href="${res.link}" target="_blank" ${downloadAttr} style="display: flex; align-items: center; justify-content: flex-end; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); text-decoration: none; color: var(--primary-color); font-weight: 600; font-size: 14px;">
                            <span style="margin-right: 5px;">${actionText}</span>
                            <ion-icon name="${iconName}"></ion-icon>
                        </a>
                    </div>
                `;
                }).join('');

            } catch (error) {
                console.error('Load resources error:', error);
                container.innerHTML = '<p style="text-align: center; color: red;">Error loading resources</p>';
            }
        };

        window.showAddResourceModal = function () {
            showResourceUploadModal();
        };

        window.addResource = async function () {
            const title = document.getElementById('res-title').value.trim();
            const link = document.getElementById('res-link').value.trim();
            const desc = document.getElementById('res-desc').value.trim();

            if (!title || !link) {
                showToast('Please enter title and link', 'error');
                return;
            }

            const uid = localStorage.getItem('kobi_atlas_uid');
            const normalizedCode = currentCourse.code.replace(/\s/g, '').toUpperCase();

            showLoading(true);

            try {
                // Get user name (rough approximation since we might not have full user profile in memory)
                // Actually we can fetch it or just use 'Student'
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.exists() ? userDoc.data() : {};
                const userName = userData.username || userData.displayName || 'Student';

                await addDoc(collection(db, 'resources'), {
                    courseCode: normalizedCode,
                    title,
                    link,
                    description: desc,
                    uploadedBy: uid,
                    uploadedByName: userName,
                    votes: 0,
                    timestamp: Date.now()
                });

                showToast('Resource added!', 'success');
                closeModal('add-resource-modal');
                document.getElementById('res-title').value = '';
                document.getElementById('res-link').value = '';
                document.getElementById('res-desc').value = '';
                loadResources();
            } catch (error) {
                console.error('Add resource error:', error);
                showToast('Error adding resource', 'error');
            }
            showLoading(false);
        };

        window.voteResource = async function (resourceId, value) {
            try {
                const ref = doc(db, 'resources', resourceId);
                await updateDoc(ref, {
                    votes: increment(value)
                });
                loadResources(); // Refresh to show new count
            } catch (error) {
                console.error('Vote error:', error);
                showToast('Error voting', 'error');
            }
        };

        // Modal functions
        window.showAddSemesterModal = function () {
            document.getElementById('add-semester-modal').classList.add('show');
        };

        window.showAddCourseModal = function () {
            document.getElementById('add-course-modal').classList.add('show');
        };

        // Duplicate closeModal removed from here to prevent conflicts/errors

        window.switchEntryMethod = function (method) {
            entryMethod = method;
            document.getElementById('manual-entry').classList.toggle('hidden', method !== 'manual');
            document.getElementById('quick-entry').classList.toggle('hidden', method !== 'quick');

            // Update tab buttons
            document.querySelectorAll('#add-semester-modal .tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (i === 0 && method === 'manual') || (i === 1 && method === 'quick'));
            });
        };

        window.selectType = function (type) {
            selectedSemesterType = type;
            ['current', 'pending', 'past'].forEach(t => {
                document.getElementById(`type-${t}`).classList.toggle('active', t === type);
            });
        };

        window.createSemester = async function () {
            const name = document.getElementById('semester-name').value.trim();
            if (!name) {
                showToast('Please enter semester name', 'error');
                return;
            }

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                // FIXED: Validation - only one current semester allowed
                if (selectedSemesterType === 'current') {
                    const semRef = collection(db, 'users', uid, 'semesters');
                    const snapshot = await getDocs(semRef);
                    const hasCurrent = snapshot.docs.some(doc => doc.data().type === 'current');

                    if (hasCurrent) {
                        showToast('A current semester already exists!', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const semRef = doc(collection(db, 'users', uid, 'semesters'));
                await setDoc(semRef, {
                    id: semRef.id,
                    name,
                    type: selectedSemesterType,
                    courses: [],
                    timestamp: Date.now()
                });

                showToast('Semester created!', 'success');
                closeModal('add-semester-modal');
                document.getElementById('semester-name').value = '';
                loadDashboard();
            } catch (error) {
                console.error('Create semester error:', error);
                showToast('Error creating semester', 'error');
            }

            showLoading(false);
        };

        window.createQuickSemester = async function () {
            const name = document.getElementById('quick-semester-name').value.trim();
            const gpa = parseFloat(document.getElementById('quick-gpa').value);
            const units = parseInt(document.getElementById('quick-units').value);

            if (!name || !gpa || !units) {
                showToast('Please fill all fields', 'error');
                return;
            }

            if (gpa < 0 || gpa > 5) {
                showToast('GPA must be between 0 and 5', 'error');
                return;
            }

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const semRef = doc(collection(db, 'users', uid, 'semesters'));
                // FIXED: Quick add always creates 'past' type
                await setDoc(semRef, {
                    id: semRef.id,
                    name,
                    type: 'past',
                    gpa,
                    totalUnits: units,
                    courses: [],
                    timestamp: Date.now()
                });

                showToast('Semester created!', 'success');
                closeModal('add-semester-modal');
                document.getElementById('quick-semester-name').value = '';
                document.getElementById('quick-gpa').value = '';
                document.getElementById('quick-units').value = '';
                loadDashboard();
            } catch (error) {
                console.error('Create quick semester error:', error);
                showToast('Error creating semester', 'error');
            }

            showLoading(false);
        };

        window.addCourse = async function () {
            const name = document.getElementById('course-title').value.trim();
            const code = document.getElementById('course-code').value.trim();
            const unitHours = parseInt(document.getElementById('course-unit-hours').value);
            const targetGrade = document.getElementById('course-target-grade').value;
            const difficulty = parseInt(document.getElementById('course-difficulty-select').value);

            if (!name || !code || !unitHours) {
                showToast('Please fill all fields', 'error');
                return;
            }

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                // FIXED: Match Android data structure exactly
                const newCourse = {
                    id: `course_${Date.now()}`,
                    name,  // NOT title
                    code,
                    unitHours,  // NOT units
                    targetGrade,
                    difficulty,
                    caScores: {
                        midSemester: 0,
                        assignment: 0,
                        quiz: 0,
                        attendance: 0
                    },
                    predictedGrade: targetGrade,
                    schedule: null,
                    examDate: null
                };

                currentSemester.courses = currentSemester.courses || [];
                currentSemester.courses.push(newCourse);

                // Recalculate semester GPA
                const semesterGPA = parseFloat(calculateSemesterGPA(currentSemester.courses));
                const totalUnits = currentSemester.courses.reduce((sum, c) => sum + (c.unitHours || 0), 0);

                await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                    courses: currentSemester.courses,
                    gpa: semesterGPA,
                    totalUnits: totalUnits
                });

                showToast('Course added!', 'success');
                closeModal('add-course-modal');
                document.getElementById('course-title').value = '';
                document.getElementById('course-code').value = '';
                document.getElementById('course-unit-hours').value = '';
                viewSemester(currentSemester.id);
            } catch (error) {
                console.error('Add course error:', error);
                showToast('Error adding course', 'error');
            }

            showLoading(false);
        };

        window.deleteSemester = async function () {
            if (!confirm('Delete this semester and all its courses?')) return;

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                await deleteDoc(doc(db, 'users', uid, 'semesters', currentSemester.id));
                showToast('Semester deleted', 'success');
                backToDashboard();
            } catch (error) {
                console.error('Delete semester error:', error);
                showToast('Error deleting semester', 'error');
            }

            showLoading(false);
        };

        // Navigation
        // Navigation
        window.switchCommunityTab = function (tab) {
            document.getElementById('community-feed-container').classList.toggle('hidden', tab !== 'feed');
            document.getElementById('community-messages-container').classList.toggle('hidden', tab !== 'messages');
            document.getElementById('community-resources-container').classList.toggle('hidden', tab !== 'resources');

            document.getElementById('comm-feed-tab').classList.toggle('active', tab === 'feed');
            document.getElementById('comm-messages-tab').classList.toggle('active', tab === 'messages');
            document.getElementById('comm-resources-tab').classList.toggle('active', tab === 'resources');

            if (tab === 'messages') {
                loadConversations();
            } else if (tab === 'resources') {
                loadResources();
            }
        };

        window.showScreen = function (screenName) {
            if (screenName === 'messages') {
                showScreen('community');
                switchCommunityTab('messages');
                return;
            }

            ['dashboard-screen', 'semester-detail-screen', 'course-detail-screen', 'planner-screen', 'gpa-screen', 'community-screen'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            document.getElementById(`${screenName}-screen`).classList.remove('hidden');

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Map screen names to nav items
            const navMap = {
                'dashboard': 0,
                'planner': 1,
                'gpa': 2,
                'community': 3
            };

            if (navMap[screenName] !== undefined) {
                document.querySelectorAll('.nav-item')[navMap[screenName]].classList.add('active');
            }

            if (screenName === 'dashboard') {
                loadDashboard();
            } else if (screenName === 'planner') {
                loadSchedule();
            } else if (screenName === 'gpa') {
                loadGPAView();
            } else if (screenName === 'community') {
                loadCommunityFeed();
                // Default to feed usually, but if we just switched to messages via recursion, verify.
                // Actually, if we just call loadCommunityFeed, it's fine.
                // switchCommunityTab('feed'); // Optional: Force feed tab on main nav click? 
                // Let's decide to NOT force feed tab so state persists if user switches back and forth within session
                // But if 'messages' was requested, it was handled above.
                if (!document.getElementById('community-messages-container').classList.contains('hidden')) {
                    loadConversations();
                } else if (!document.getElementById('community-resources-container').classList.contains('hidden')) {
                    loadResources();
                }
            }
        };

        window.backToDashboard = function () {
            showScreen('dashboard');
        };

        window.backToSemester = function () {
            viewSemester(currentSemester.id);
        };

        window.switchTab = function (tab) {
            // Only info tab exists now, but keep function for potential future tabs or simplifiction
            // Actually, we can just enforce 'info'

            document.getElementById('course-info-tab').classList.remove('hidden');
            // document.getElementById('course-resources-tab').classList.add('hidden'); // Element removed

            document.querySelectorAll('#course-detail-screen .tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0);
            });
        };

        window.showSettings = function () {
            if (confirm('Logout?')) {
                localStorage.clear();
                location.reload();
            }
        };

        // COMMUNITY FUNCTIONS
        let allPosts = [];
        let allResources = [];

        window.showResourceUploadModal = function () {
            // Reset form
            document.getElementById('res-course-code').value = '';
            document.getElementById('res-title').value = '';
            document.getElementById('res-desc').value = '';
            document.getElementById('res-link').value = '';
            document.getElementById('res-image-file').value = '';
            document.getElementById('res-file-input').value = '';
            document.getElementById('res-image-preview').style.display = 'none';
            document.getElementById('res-file-info').textContent = '';

            // Reset resource type to link
            selectedResourceType = 'link';
            resourceImageData = null;
            resourceFileData = null;
            resourceFileName = null;
            setResourceType('link');

            document.getElementById('resource-upload-modal').classList.add('show');
        };

        window.loadResources = async function () {
            showLoading(true);
            try {
                const q = query(collection(db, 'resources'), orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);

                allResources = [];
                snapshot.forEach(doc => {
                    allResources.push({ id: doc.id, ...doc.data() });
                });

                renderResources(allResources);
            } catch (error) {
                console.error('Error loading resources:', error);
                showToast('Failed to load resources', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.renderResources = function (resources) {
            const container = document.getElementById('resources-list');
            if (resources.length === 0) {
                container.innerHTML = '<div class="empty-container"><p class="empty-text">No resources found. Upload one!</p></div>';
                return;
            }

            const currentUid = localStorage.getItem('kobi_atlas_uid');

            container.innerHTML = resources.map(res => {
                const isOwner = res.uploadedBy === currentUid;

                // Content based on type
                let contentHtml = '';
                if (res.type === 'image') {
                    contentHtml = `
                        <div style="margin: 8px 0; cursor: pointer;" onclick="openLightbox('${res.imageData}')">
                            <img src="${res.imageData}" style="max-width: 100%; border-radius: 8px; max-height: 200px; object-fit: cover;">
                        </div>
                    `;
                } else if (res.type === 'file') {
                    contentHtml = `
                        <div style="margin: 8px 0; background: #2a2a2a; padding: 12px; border-radius: 8px; display: flex; align-items: center;">
                            <ion-icon name="document-text-outline" style="font-size: 24px; color: var(--primary-color); margin-right: 12px;"></ion-icon>
                            <div style="flex: 1; overflow: hidden;">
                                <div style="font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${res.fileName || 'Document'}</div>
                                <div style="font-size: 12px; color: #999;">${res.fileSize || 'File'}</div>
                            </div>
                            <a href="${res.fileData}" target="_blank" style="color: var(--primary-color); margin-right: 12px;" title="View">
                                <ion-icon name="eye-outline" style="font-size: 24px;"></ion-icon>
                            </a>
                            <a href="${res.fileData}" download="${res.fileName || 'download'}" style="color: var(--primary-color);" title="Download">
                                <ion-icon name="download-outline" style="font-size: 24px;"></ion-icon>
                            </a>
                        </div>
                    `;
                } else {
                    // Link (default)
                    contentHtml = `
                        <a href="${res.link}" target="_blank" style="color: var(--primary-color); font-weight: bold; text-decoration: none; display: inline-flex; align-items: center; margin-top: 4px;">
                            Open Link <ion-icon name="open-outline" style="margin-left: 4px;"></ion-icon>
                        </a>
                    `;
                }

                return `
                <div class="stat-card" style="margin-bottom: 12px; padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: var(--primary-color); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-right: 8px;">
                                    ${res.courseCode}
                                </span>
                                <span style="font-size: 12px; color: #999;">${new Date(res.timestamp).toLocaleDateString()}</span>
                            </div>
                            
                            <h3 style="margin: 0 0 4px 0; font-size: 16px;">${res.title}</h3>
                            ${res.description ? `<p style="font-size: 14px; color: #ccc; margin-bottom: 8px;">${res.description}</p>` : ''}
                            
                            ${contentHtml}

                            <div style="display: flex; align-items: center; margin-top: 12px;">
                                ${res.uploadedByProfilePicture
                        ? `<img src="${res.uploadedByProfilePicture}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; object-fit: cover;">`
                        : `<div style="width: 24px; height: 24px; border-radius: 50%; background: #444; margin-right: 8px; display: flex; align-items: center; justify-content: center;"><ion-icon name="person" style="font-size: 14px; color: #ccc;"></ion-icon></div>`
                    }
                                <div style="font-size: 12px; color: #888;">Shared by ${res.uploadedByName || 'Student'}</div>
                                
                                ${isOwner ? `
                                    <button onclick="deleteResource('${res.id}')" style="margin-left: auto; background: none; border: none; cursor: pointer; color: #dc3545; display: flex; align-items: center;">
                                        <ion-icon name="trash-outline"></ion-icon>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; padding-left: 16px;">
                            <button onclick="voteResource('${res.id}', 1)" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                <ion-icon name="caret-up-outline" style="font-size: 24px; color: var(--primary-color);"></ion-icon>
                            </button>
                            <span style="font-weight: bold;">${res.votes || 0}</span>
                            <button onclick="voteResource('${res.id}', -1)" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                <ion-icon name="caret-down-outline" style="font-size: 24px; color: #888;"></ion-icon>
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
        };

        window.filterResources = function (queryText) {
            if (!queryText) {
                renderResources(allResources);
                return;
            }
            const lower = queryText.toLowerCase();
            const filtered = allResources.filter(r =>
                r.title.toLowerCase().includes(lower) ||
                r.courseCode.toLowerCase().includes(lower) ||
                (r.description && r.description.toLowerCase().includes(lower))
            );
            renderResources(filtered);
        };

        // Resource Management Variables
        let selectedResourceType = 'link';
        let resourceImageData = null;
        let resourceFileData = null;
        let resourceFileName = null;

        window.setResourceType = function (type) {
            selectedResourceType = type;

            // Update button styles
            document.getElementById('res-type-link').classList.toggle('btn-primary', type === 'link');
            document.getElementById('res-type-link').classList.toggle('btn-secondary', type !== 'link');
            document.getElementById('res-type-image').classList.toggle('btn-primary', type === 'image');
            document.getElementById('res-type-image').classList.toggle('btn-secondary', type !== 'image');
            document.getElementById('res-type-file').classList.toggle('btn-primary', type === 'file');
            document.getElementById('res-type-file').classList.toggle('btn-secondary', type !== 'file');

            // Show/hide appropriate containers
            document.getElementById('res-link-container').classList.toggle('hidden', type !== 'link');
            document.getElementById('res-image-container').classList.toggle('hidden', type !== 'image');
            document.getElementById('res-file-container').classList.toggle('hidden', type !== 'file');
        };

        window.handleResourceImageSelect = async function (event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                // Use compression utility - no need for manual size check
                resourceImageData = await compressResourceImage(file);
                document.getElementById('res-image-preview').src = resourceImageData;
                document.getElementById('res-image-preview').style.display = 'block';
            } catch (error) {
                console.error('Resource image error:', error);
                showToast('Failed to process image', 'error');
                event.target.value = '';
            }
        };

        window.handleResourceFileSelect = function (event) {
            const file = event.target.files[0];
            if (!file) return;

            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showToast('File size must be less than 10MB', 'error');
                event.target.value = '';
                return;
            }

            resourceFileName = file.name;
            const reader = new FileReader();
            reader.onload = function (e) {
                resourceFileData = e.target.result;
                const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
                document.getElementById('res-file-info').textContent = `Selected: ${file.name} (${sizeInMB} MB)`;
            };
            reader.readAsDataURL(file);
        };

        window.uploadResource = async function () {
            const courseCode = document.getElementById('res-course-code').value.trim();
            const title = document.getElementById('res-title').value.trim();
            const description = document.getElementById('res-desc').value.trim();

            if (!courseCode || !title) {
                showToast('Please fill course code and title', 'error');
                return;
            }

            // Validate based on type
            if (selectedResourceType === 'link') {
                const link = document.getElementById('res-link').value.trim();
                if (!link) {
                    showToast('Please enter a link', 'error');
                    return;
                }
            } else if (selectedResourceType === 'image' && !resourceImageData) {
                showToast('Please select an image', 'error');
                return;
            } else if (selectedResourceType === 'file' && !resourceFileData) {
                showToast('Please select a file', 'error');
                return;
            }

            showLoading(true);
            try {
                const uid = localStorage.getItem('kobi_atlas_uid');
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.data() || {};

                const resourceData = {
                    courseCode,
                    title,
                    description,
                    uploadedBy: uid,
                    uploadedByName: userData.username || userData.displayName || 'Student',
                    uploadedByProfilePicture: userData.profilePicture || null,
                    timestamp: Date.now(),
                    votes: 0,
                    type: selectedResourceType
                };

                if (selectedResourceType === 'link') {
                    resourceData.link = document.getElementById('res-link').value.trim();
                } else if (selectedResourceType === 'image') {
                    resourceData.imageData = resourceImageData;
                } else if (selectedResourceType === 'file') {
                    resourceData.fileData = resourceFileData;
                    resourceData.fileName = resourceFileName;
                }

                await addDoc(collection(db, 'resources'), resourceData);

                showToast('Resource uploaded!', 'success');
                closeModal('resource-upload-modal');

                // Reset form
                document.getElementById('res-course-code').value = '';
                document.getElementById('res-title').value = '';
                document.getElementById('res-desc').value = '';
                document.getElementById('res-link').value = '';
                document.getElementById('res-image-file').value = '';
                document.getElementById('res-file-input').value = '';
                document.getElementById('res-image-preview').style.display = 'none';
                document.getElementById('res-file-info').textContent = '';
                resourceImageData = null;
                resourceFileData = null;
                resourceFileName = null;
                setResourceType('link'); // Reset to link

                loadResources();
            } catch (error) {
                console.error('Error uploading resource:', error);
                if (error.message && (error.message.includes('longer than') || error.message.includes('too large'))) {
                    showToast('File size is too large. Please use a smaller file.', 'error');
                } else {
                    showToast('Failed to upload', 'error');
                }
            } finally {
                showLoading(false);
            }
        };

        window.deleteResource = async function (resourceId, uploaderId) {
            const uid = localStorage.getItem('kobi_atlas_uid');

            if (uid !== uploaderId) {
                showToast('You can only delete your own resources', 'error');
                return;
            }

            if (!confirm('Delete this resource?')) return;

            showLoading(true);
            try {
                await deleteDoc(doc(db, 'resources', resourceId));
                showToast('Resource deleted', 'success');
                loadResources();
            } catch (error) {
                console.error('Error deleting resource:', error);
                showToast('Failed to delete resource', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.voteResource = async function (id, value) {
            try {
                // Optimistic update
                const idx = allResources.findIndex(r => r.id === id);
                if (idx !== -1) {
                    allResources[idx].votes = (allResources[idx].votes || 0) + value;
                    renderResources(allResources); // Re-render only filtered? Ideally filterResources(document.getElementById('resource-search-input').value)
                }

                const resRef = doc(db, 'resources', id);
                await updateDoc(resRef, {
                    votes: increment(value)
                });
            } catch (error) {
                console.error('Error voting:', error);
            }
        };


        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now.getTime() - date.getTime();
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        async function loadCommunityFeed() {
            const uid = localStorage.getItem('kobi_atlas_uid');
            // Only show full loading if we don't have posts or explicit refresh? 
            // For now, let's show it to be safe as per requirements.
            // If it causes flashing on likes, we can optimize later.
            // Actually, for likes, we might want to avoid it, but let's stick to the prompt.
            // But wait, the 'toggleLike' function calls loadCommunityFeed(). Flashing overlay on every like is bad UX.
            // Let's check if the feed is already populated? 
            // No, the requirement is "whenever data is being fetched". 
            // I'll add it.

            const isRefresing = document.getElementById('posts-feed').children.length > 0;
            if (!isRefresing) showLoading(true);

            try {
                const postsRef = collection(db, 'posts');
                const q = query(postsRef, orderBy('timestamp', 'desc'));
                const snapshot = await getDocs(q);

                allPosts = [];
                for (const docSnap of snapshot.docs) {
                    const postData = { id: docSnap.id, ...docSnap.data() };

                    // Check if post is deleted
                    if (postData.deleted) continue;

                    // Check if author still exists
                    const authorDoc = await getDoc(doc(db, 'users', postData.authorId));
                    if (!authorDoc.exists()) continue; // Skip posts by deleted users

                    allPosts.push({ ...postData, authorEmail: authorDoc.data().email });
                }

                const feedHTML = allPosts.length > 0 ? allPosts.map(post => {
                    const isLiked = post.likes?.includes(uid) || false;
                    const isAuthor = post.authorId === uid;
                    const likeCount = post.likes?.length || 0;
                    const replyCount = post.replies?.length || 0;

                    return `
                        <div class="stat-card" style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="display: flex; gap: 12px; align-items: center; flex: 1;">
                                    <div style="cursor: pointer;" onclick="viewUserProfile('${post.authorId}')">
                                        ${post.profilePicture ?
                            `<img src="${post.profilePicture}" style="width: 40px; height: 40px; border-radius: 20px; object-fit: cover;">` :
                            `<div style="width: 40px; height: 40px; border-radius: 20px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${post.username?.[0]?.toUpperCase() || 'U'}</div>`
                        }
                                    </div>
                                    <div>
                                        <div style="font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px;" onclick="viewUserProfile('${post.authorId}')">
                                            ${post.username || 'Anonymous'}
                                            ${isOwner({ email: post.authorEmail }) ? '<ion-icon name="shield-checkmark" style="color: #FFD700; font-size: 14px; margin-left: 4px;"></ion-icon>' : ''}
                                        </div>
                                        <div style="font-size: 12px; color: #999;">${formatTime(post.timestamp)}</div>
                                    </div>
                                </div>
                                ${isAuthor ? `
                                    <button onclick="deletePost('${post.id}')" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                        <ion-icon name="trash-outline" style="font-size: 20px; color: #dc3545;"></ion-icon>
                                    </button>
                                ` : ''}
                            </div>
                            
                            ${post.contentText ? `<p style="margin-bottom: 12px;">${post.contentText}</p>` : ''}
                            
                            ${post.contentImage ? `
                                <div style="cursor: pointer;" onclick="openLightbox('${post.contentImage}')">
                                    <img src="${post.contentImage}" style="width: 100%; border-radius: 8px; margin-bottom: 12px; height: auto; max-height: 400px; object-fit: contain; background: rgba(0,0,0,0.05);">
                                </div>
                            ` : ''}
                            
                            ${post.contentLink ? `
                                <a href="${post.contentLink}" target="_blank" style="color: #667eea; text-decoration: none; display: block; margin-bottom: 12px;">
                                    🔗 ${post.contentLink}
                                </a>
                            ` : ''}
                            
                            <div style="display: flex; gap: 16px; padding-top: 12px; border-top: 1px solid #333;">
                                <button onclick="toggleLike('${post.id}', ${isLiked})" style="background: ${isLiked ? 'rgba(220, 53, 69, 0.1)' : 'none'}; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 6px;">
                                    <ion-icon name="${isLiked ? 'heart' : 'heart-outline'}" style="font-size: 20px; color: ${isLiked ? '#dc3545' : '#999'};"></ion-icon>
                                    <span style="color: ${isLiked ? '#dc3545' : '#999'};">${likeCount}</span>
                                </button>
                                <button onclick="openPostDetail('${post.id}')" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 6px;">
                                    <ion-icon name="chatbubble-outline" style="font-size: 20px; color: #999;"></ion-icon>
                                    <span style="color: #999;">${replyCount}</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('') : '<div class="empty-container"><p class="empty-text">No posts yet. Be the first to share something!</p></div>';

                document.getElementById('posts-feed').innerHTML = feedHTML;

            } catch (error) {
                console.error('Load community feed error:', error);
                showToast('Error loading posts', 'error');
                document.getElementById('posts-feed').innerHTML = '<div class="empty-container"><p class="empty-text">Error loading posts. Please try again.</p></div>';
            } finally {
                if (!isRefresing) showLoading(false);
            }
        }

        window.showCreatePostModal = function () {
            document.getElementById('create-post-modal').classList.add('show');
        };

        // Image upload handler with inline compression fallback
        let uploadedImageBase64 = null;

        // Inline compression function as fallback
        function compressImageInline(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        window.handleImageUpload = async function (input, previewId) {
            const file = input.files[0];
            if (file) {
                try {
                    console.log('BRUTE-FORCE compression starting for:', file.name, file.size);

                    // BRUTE FORCE: Manual canvas compression - 400px @ 0.5 quality
                    uploadedImageBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                const maxSize = 400;

                                if (width > height) {
                                    if (width > maxSize) {
                                        height *= maxSize / width;
                                        width = maxSize;
                                    }
                                } else {
                                    if (height > maxSize) {
                                        width *= maxSize / height;
                                        height = maxSize;
                                    }
                                }

                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);

                                resolve(canvas.toDataURL('image/jpeg', 0.5));
                            };
                            img.onerror = () => reject(new Error('Image load failed'));
                            img.src = e.target.result;
                        };
                        reader.onerror = () => reject(new Error('File read failed'));
                        reader.readAsDataURL(file);
                    });

                    console.log('Compression complete, final size:', uploadedImageBase64.length, 'characters');
                    const preview = document.getElementById(previewId);
                    preview.src = uploadedImageBase64;
                    preview.style.display = 'block';
                } catch (error) {
                    console.error('Image upload error:', error);
                    showToast('Failed to process image', 'error');
                }
            }
        };

        window.createPost = async function () {
            const content = document.getElementById('post-content').value.trim();
            const link = document.getElementById('post-link').value.trim();

            if (!content && !uploadedImageBase64 && !link) {
                showToast('Please add some content to your post', 'error');
                return;
            }

            const uid = localStorage.getItem('kobi_atlas_uid');


            try {
                // Get user data
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.data() || {};

                const postRef = doc(collection(db, 'posts'));
                await setDoc(postRef, {
                    id: postRef.id,
                    authorId: uid,
                    username: userData.username || userData.displayName || 'Anonymous',
                    profilePicture: userData.profilePicture || null,
                    contentText: content || null,
                    contentImage: uploadedImageBase64 || null,
                    contentLink: link || null,
                    timestamp: Date.now(),
                    likes: [],
                    replies: []
                });

                showToast('Post created!', 'success');
                closeModal('create-post-modal');
                document.getElementById('post-content').value = '';
                document.getElementById('post-image').value = '';
                document.getElementById('post-link').value = '';
                document.getElementById('post-image-preview').style.display = 'none';
                uploadedImageBase64 = null;
                loadCommunityFeed();

            } catch (error) {
                console.error('Create post error:', error);
                showToast('Error creating post', 'error');
            }
        };

        window.toggleLike = async function (postId, isLiked) {
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const postRef = doc(db, 'posts', postId);
                const postDoc = await getDoc(postRef);
                const postData = postDoc.data();

                let likes = postData.likes || [];

                if (isLiked) {
                    likes = likes.filter(id => id !== uid);
                } else {
                    likes.push(uid);
                }

                await updateDoc(postRef, { likes });
                loadCommunityFeed();

            } catch (error) {
                console.error('Toggle like error:', error);
                showToast('Error updating like', 'error');
            }
        };

        window.deletePost = async function (postId) {
            if (!confirm('Delete this post?')) return;

            try {
                await deleteDoc(doc(db, 'posts', postId));
                showToast('Post deleted', 'success');
                loadCommunityFeed();
            } catch (error) {
                console.error('Delete post error:', error);
                showToast('Error deleting post', 'error');
            }
        };

        // POST DETAIL FUNCTIONS
        let currentPost = null;
        let currentReplies = [];

        window.openPostDetail = async function (postId) {
            try {
                // Get post
                const postDoc = await getDoc(doc(db, 'posts', postId));
                if (!postDoc.exists()) {
                    showToast('Post not found', 'error');
                    return;
                }

                currentPost = { id: postDoc.id, ...postDoc.data() };

                // Get replies - use where only, then sort in JS to avoid composite index
                const repliesRef = collection(db, 'replies');
                const q = query(repliesRef, where('postId', '==', postId));
                const snapshot = await getDocs(q);

                currentReplies = [];
                snapshot.forEach(doc => {
                    currentReplies.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp in JavaScript
                currentReplies.sort((a, b) => a.timestamp - b.timestamp);

                // Render post detail
                const uid = localStorage.getItem('kobi_atlas_uid');
                const isLiked = currentPost.likes?.includes(uid) || false;
                const isAuthor = currentPost.authorId === uid;
                const likeCount = currentPost.likes?.length || 0;

                const postHTML = `
                    <div style="padding: 16px; background: #2a2a2a; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="display: flex; gap: 12px; align-items: center; flex: 1;">
                                ${currentPost.profilePicture ?
                        `<img src="${currentPost.profilePicture}" style="width: 40px; height: 40px; border-radius: 20px; object-fit: cover;">` :
                        `<div style="width: 40px; height: 40px; border-radius: 20px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${currentPost.username?.[0]?.toUpperCase() || 'U'}</div>`
                    }
                                <div>
                                    <div style="font-weight: bold;">${currentPost.username || 'Anonymous'}</div>
                                    <div style="font-size: 12px; color: #999;">${formatTime(currentPost.timestamp)}</div>
                                </div>
                            </div>
                            ${isAuthor ? `
                                <button onclick="deletePostFromDetail('${currentPost.id}')" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                    <ion-icon name="trash-outline" style="font-size: 20px; color: #dc3545;"></ion-icon>
                                </button>
                            ` : ''}
                        </div>
                        
                        ${currentPost.contentText ? `<p style="margin-bottom: 12px;">${currentPost.contentText}</p>` : ''}
                        
                        ${currentPost.contentImage ? `
                            <img src="${currentPost.contentImage}" style="width: 100%; border-radius: 8px; margin-bottom: 12px; max-height: 400px; object-fit: cover;">
                        ` : ''}
                        
                        <div style="display: flex; gap: 16px; padding-top: 12px; border-top: 1px solid #333;">
                            <button onclick="toggleLikeInDetail('${currentPost.id}', ${isLiked})" style="background: ${isLiked ? 'rgba(220, 53, 69, 0.1)' : 'none'}; border: none; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 6px;">
                                <ion-icon name="${isLiked ? 'heart' : 'heart-outline'}" style="font-size: 20px; color: ${isLiked ? '#dc3545' : '#999'};"></ion-icon>
                                <span style="color: ${isLiked ? '#dc3545' : '#999'};">${likeCount}</span>
                            </button>
                            <div style="display: flex; align-items: center; gap: 6px; padding: 8px 12px;">
                                <ion-icon name="chatbubble-outline" style="font-size: 20px; color: #999;"></ion-icon>
                                <span style="color: #999;">${currentReplies.length}</span>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('post-detail-content').innerHTML = postHTML;
                document.getElementById('replies-count').textContent = currentReplies.length;

                // Render replies
                renderReplies();

                // Show modal
                document.getElementById('post-detail-modal').classList.add('show');

            } catch (error) {
                console.error('Open post detail error:', error);
                showToast('Error loading post', 'error');
            }
        };

        function renderReplies() {
            const uid = localStorage.getItem('kobi_atlas_uid');

            const repliesHTML = currentReplies.length > 0 ? currentReplies.map(reply => {
                const isLiked = reply.likes?.includes(uid) || false;
                const isAuthor = reply.authorId === uid;
                const likeCount = reply.likes?.length || 0;

                return `
                    <div style="padding: 12px; background: #2a2a2a; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                            ${reply.profilePicture ?
                        `<img src="${reply.profilePicture}" style="width: 32px; height: 32px; border-radius: 16px; object-fit: cover;">` :
                        `<div style="width: 32px; height: 32px; border-radius: 16px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">${reply.username?.[0]?.toUpperCase() || 'U'}</div>`
                    }
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 14px;">${reply.username || 'Anonymous'}</div>
                                <div style="font-size: 11px; color: #999;">${formatTime(reply.timestamp)}</div>
                            </div>
                            ${isAuthor ? `
                                <button onclick="deleteReply('${reply.id}')" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                    <ion-icon name="trash-outline" style="font-size: 16px; color: #dc3545;"></ion-icon>
                                </button>
                            ` : ''}
                        </div>
                        
                        <p style="font-size: 14px; margin-bottom: 8px;">${reply.contentText}</p>
                        
                        ${reply.contentImage ? `
                            <img src="${reply.contentImage}" style="width: 100%; border-radius: 8px; margin-bottom: 8px; max-height: 200px; object-fit: cover;">
                        ` : ''}
                        
                        <button onclick="toggleReplyLike('${reply.id}', ${isLiked})" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 4px;">
                            <ion-icon name="${isLiked ? 'heart' : 'heart-outline'}" style="font-size: 16px; color: ${isLiked ? '#dc3545' : '#999'};"></ion-icon>
                            <span style="color: ${isLiked ? '#dc3545' : '#999'}; font-size: 13px;">${likeCount}</span>
                        </button>
                    </div>
                `;
            }).join('') : '<p style="text-align: center; color: #999; padding: 20px;">No replies yet. Be the first to reply!</p>';

            document.getElementById('replies-list').innerHTML = repliesHTML;
        }

        window.createReply = async function () {
            const content = document.getElementById('reply-input').value.trim();

            if (!content) {
                showToast('Please enter a reply', 'error');
                return;
            }

            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                // Get user data
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.data() || {};

                const replyRef = doc(collection(db, 'replies'));
                await setDoc(replyRef, {
                    id: replyRef.id,
                    postId: currentPost.id,
                    authorId: uid,
                    username: userData.username || userData.displayName || 'Anonymous',
                    profilePicture: userData.profilePicture || null,
                    contentText: content,
                    contentImage: null,
                    timestamp: Date.now(),
                    likes: []
                });

                // Update post replies array
                const postRef = doc(db, 'posts', currentPost.id);
                const postDoc = await getDoc(postRef);
                const postData = postDoc.data();
                const replies = postData.replies || [];
                replies.push(replyRef.id);
                await updateDoc(postRef, { replies });

                showToast('Reply added!', 'success');
                document.getElementById('reply-input').value = '';

                // Reload post detail
                openPostDetail(currentPost.id);

            } catch (error) {
                console.error('Create reply error:', error);
                showToast('Error creating reply', 'error');
            }
        };

        window.toggleLikeInDetail = async function (postId, isLiked) {
            await toggleLike(postId, isLiked);
            openPostDetail(postId);
        };

        window.toggleReplyLike = async function (replyId, isLiked) {
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const replyRef = doc(db, 'replies', replyId);
                const replyDoc = await getDoc(replyRef);
                const replyData = replyDoc.data();

                let likes = replyData.likes || [];

                if (isLiked) {
                    likes = likes.filter(id => id !== uid);
                } else {
                    likes.push(uid);
                }

                await updateDoc(replyRef, { likes });
                openPostDetail(currentPost.id);

            } catch (error) {
                console.error('Toggle reply like error:', error);
                showToast('Error updating like', 'error');
            }
        };

        window.deleteReply = async function (replyId) {
            if (!confirm('Delete this reply?')) return;

            try {
                // Delete reply document
                await deleteDoc(doc(db, 'replies', replyId));

                // Update post replies array
                const postRef = doc(db, 'posts', currentPost.id);
                const postDoc = await getDoc(postRef);
                const postData = postDoc.data();
                const replies = (postData.replies || []).filter(id => id !== replyId);
                await updateDoc(postRef, { replies });

                showToast('Reply deleted', 'success');
                openPostDetail(currentPost.id);
            } catch (error) {
                console.error('Delete reply error:', error);
                showToast('Error deleting reply', 'error');
            }
        };

        window.deletePostFromDetail = async function (postId) {
            if (!confirm('Delete this post?')) return;

            try {
                await deleteDoc(doc(db, 'posts', postId));
                showToast('Post deleted', 'success');
                closeModal('post-detail-modal');
                loadCommunityFeed();
            } catch (error) {
                console.error('Delete post error:', error);
                showToast('Error deleting post', 'error');
            }
        };

        // GPA VIEW FUNCTIONS
        let currentGPATab = 'current';

        window.switchGPATab = function (tab) {
            currentGPATab = tab;
            document.getElementById('gpa-current-tab').classList.toggle('active', tab === 'current');
            document.getElementById('gpa-predicted-tab').classList.toggle('active', tab === 'predicted');
            loadGPAView();
        };

        function getDegreeClassification(gpa) {
            if (gpa >= 4.50) return { label: 'First Class', color: '#FFD700', icon: 'star' };
            if (gpa >= 3.50) return { label: 'Second Class (Upper Division)', color: '#4CAF50', icon: 'checkmark-circle' };
            if (gpa >= 2.40) return { label: 'Second Class (Lower Division)', color: '#FF9800', icon: 'remove-circle' };
            if (gpa >= 1.50) return { label: 'Third Class', color: '#9E9E9E', icon: 'ellipse' };
            return { label: 'Fail', color: '#F44336', icon: 'alert-circle' };
        }

        async function loadGPAView() {
            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);

                const semesters = [];
                snapshot.forEach(doc => {
                    semesters.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp
                semesters.sort((a, b) => a.timestamp - b.timestamp);

                // Get relevant semesters based on tab
                const relevantSemesters = currentGPATab === 'current'
                    ? semesters.filter(s => s.type === 'past')
                    : semesters;

                // Calculate aggregate stats
                let totalPoints = 0;
                let totalUnits = 0;

                relevantSemesters.forEach(sem => {
                    if (sem.type === 'past' && sem.gpa && sem.totalUnits) {
                        totalPoints += sem.gpa * sem.totalUnits;
                        totalUnits += sem.totalUnits;
                    } else if (sem.courses) {
                        const semGPA = parseFloat(calculateSemesterGPA(sem.courses));
                        const semUnits = sem.courses.reduce((sum, c) => sum + (c.unitHours || 0), 0);
                        totalPoints += semGPA * semUnits;
                        totalUnits += semUnits;
                    }
                });

                const gpa = totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : '0.00';
                const classification = getDegreeClassification(parseFloat(gpa));

                // Update classification
                document.getElementById('classification-icon').setAttribute('name', classification.icon);
                document.getElementById('classification-icon').style.color = classification.color;
                document.getElementById('classification-label').textContent = classification.label;
                document.getElementById('classification-label').style.color = classification.color;

                // Update stats
                document.getElementById('gpa-main-value').textContent = gpa;
                document.getElementById('gpa-main-label').textContent = currentGPATab === 'current' ? 'Cumulative GPA' : 'Predicted GPA';
                document.getElementById('gpa-credits').textContent = totalUnits;
                document.getElementById('gpa-semesters').textContent = relevantSemesters.length;

                // Calculate trend
                if (currentGPATab === 'predicted' && semesters.length > 0) {
                    // On Predicted tab: Compare Predicted CGPA vs Current CGPA
                    const pastSemesters = semesters.filter(s => s.type === 'past');

                    // Calculate current CGPA (past only)
                    let currentPoints = 0;
                    let currentUnits = 0;
                    pastSemesters.forEach(sem => {
                        if (sem.gpa && sem.totalUnits) {
                            currentPoints += sem.gpa * sem.totalUnits;
                            currentUnits += sem.totalUnits;
                        } else if (sem.courses) {
                            const semGPA = parseFloat(calculateSemesterGPA(sem.courses));
                            const semUnits = sem.courses.reduce((sum, c) => sum + (c.unitHours || 0), 0);
                            currentPoints += semGPA * semUnits;
                            currentUnits += semUnits;
                        }
                    });
                    const currentCGPA = currentUnits > 0 ? currentPoints / currentUnits : 0;
                    const predictedCGPA = parseFloat(gpa);

                    const diff = predictedCGPA - currentCGPA;

                    const trendIcon = document.getElementById('trend-icon');
                    const trendValue = document.getElementById('trend-value');

                    if (diff > 0.01) {
                        trendIcon.setAttribute('name', 'trending-up');
                        trendIcon.style.color = '#4CAF50';
                        trendValue.textContent = '↑';
                    } else if (diff < -0.01) {
                        trendIcon.setAttribute('name', 'trending-down');
                        trendIcon.style.color = '#F44336';
                        trendValue.textContent = '↓';
                    } else {
                        trendIcon.setAttribute('name', 'remove');
                        trendIcon.style.color = '#999';
                        trendValue.textContent = '→';
                    }
                } else if (relevantSemesters.length >= 2) {
                    // On Current tab: Compare last two semesters
                    const lastSem = relevantSemesters[relevantSemesters.length - 1];
                    const prevSem = relevantSemesters[relevantSemesters.length - 2];

                    // Get GPA for each semester (handle Quick Add semesters)
                    const lastGPA = lastSem.gpa || parseFloat(calculateSemesterGPA(lastSem.courses || []));
                    const prevGPA = prevSem.gpa || parseFloat(calculateSemesterGPA(prevSem.courses || []));

                    const diff = lastGPA - prevGPA;

                    const trendIcon = document.getElementById('trend-icon');
                    const trendValue = document.getElementById('trend-value');

                    if (diff > 0.01) {
                        trendIcon.setAttribute('name', 'trending-up');
                        trendIcon.style.color = '#4CAF50';
                        trendValue.textContent = '↑';
                    } else if (diff < -0.01) {
                        trendIcon.setAttribute('name', 'trending-down');
                        trendIcon.style.color = '#F44336';
                        trendValue.textContent = '↓';
                    } else {
                        trendIcon.setAttribute('name', 'remove');
                        trendIcon.style.color = '#999';
                        trendValue.textContent = '→';
                    }
                }

                // Render GPA Chart
                const chartHTML = relevantSemesters.map(sem => {
                    const semGPA = sem.gpa || parseFloat(calculateSemesterGPA(sem.courses || []));
                    const height = (semGPA / 5.0) * 150;
                    const color = sem.type === 'past' ? '#667eea' : '#00d4ff';
                    return `
                        <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                            <div style="width: 40px; background: ${color}; height: ${height}px; border-radius: 4px 4px 0 0; display: flex; align-items: flex-start; justify-content: center; padding-top: 4px;">
                                <span style="font-size: 10px; color: white; font-weight: bold;">${semGPA.toFixed(2)}</span>
                            </div>
                            <span style="font-size: 10px; color: #999; margin-top: 4px;">${sem.name.split(' ')[0]}</span>
                        </div>
                    `;
                }).join('');
                document.getElementById('gpa-chart').innerHTML = chartHTML;

                // Find best and worst semesters
                if (relevantSemesters.length > 0) {
                    const semestersWithGPA = relevantSemesters.map(s => ({
                        ...s,
                        gpa: s.gpa || parseFloat(calculateSemesterGPA(s.courses || []))
                    }));

                    const best = semestersWithGPA.reduce((max, s) => s.gpa > max.gpa ? s : max);
                    const worst = semestersWithGPA.reduce((min, s) => s.gpa < min.gpa ? s : min);

                    document.getElementById('best-semester').innerHTML = `Best Semester: <strong>${best.name}</strong> (${best.gpa.toFixed(2)})`;
                    document.getElementById('worst-semester').innerHTML = `Lowest Semester: <strong>${worst.name}</strong> (${worst.gpa.toFixed(2)})`;
                }

                // Grade Distribution (only for past semesters with grades)
                const distribution = {};
                semesters.filter(s => s.type === 'past').forEach(sem => {
                    sem.courses?.forEach(course => {
                        const grade = course.grade || course.predictedGrade;
                        if (grade) {
                            distribution[grade] = (distribution[grade] || 0) + 1;
                        }
                    });
                });

                const total = Object.values(distribution).reduce((a, b) => a + b, 0);
                if (total > 0) {
                    const distHTML = ['A', 'B', 'C', 'D', 'E', 'F'].map(grade => {
                        const count = distribution[grade] || 0;
                        if (count === 0) return '';
                        const percentage = (count / total) * 100;
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <span style="width: 20px; font-weight: bold;">${grade}</span>
                                <div style="flex: 1; background: #333; height: 20px; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${percentage}%; background: #667eea; height: 100%;"></div>
                                </div>
                                <span style="width: 30px; text-align: right; font-size: 12px; color: #999;">${count}</span>
                            </div>
                        `;
                    }).join('');
                    document.getElementById('distribution-content').innerHTML = distHTML;
                    document.getElementById('grade-distribution').style.display = 'block';
                } else {
                    document.getElementById('grade-distribution').style.display = 'none';
                }

                // Semester Breakdown
                const breakdownHTML = relevantSemesters.map(sem => {
                    const semGPA = sem.gpa || parseFloat(calculateSemesterGPA(sem.courses || []));
                    const credits = sem.totalUnits || sem.courses?.reduce((sum, c) => sum + (c.unitHours || 0), 0) || 0;
                    const courseCount = sem.courses?.length || 0;
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; cursor: pointer;" onclick="viewSemester('${sem.id}')">
                            <div>
                                <div style="font-weight: bold;">${sem.name}</div>
                                <div style="font-size: 12px; color: #999; margin-top: 4px;">${courseCount} courses • ${credits} credits</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px; font-weight: bold; color: #667eea;">${semGPA.toFixed(2)}</span>
                                <ion-icon name="chevron-forward" style="color: #999;"></ion-icon>
                            </div>
                        </div>
                    `;
                }).join('');
                document.getElementById('semester-breakdown').innerHTML = breakdownHTML || '<p style="text-align: center; color: #999; padding: 20px;">No semesters yet</p>';

            } catch (error) {
                console.error('Load GPA view error:', error);
                showToast('Error loading GPA data', 'error');
            } finally {
                showLoading(false);
            }
        }

        // PLANNER FUNCTIONS
        let currentPlannerTab = 'schedule';
        let allTasks = [];
        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        window.switchPlannerTab = function (tab) {
            currentPlannerTab = tab;
            document.getElementById('schedule-tab').classList.toggle('hidden', tab !== 'schedule');
            document.getElementById('tasks-tab').classList.toggle('hidden', tab !== 'tasks');
            document.getElementById('schedule-tab-btn').classList.toggle('active', tab === 'schedule');
            document.getElementById('tasks-tab-btn').classList.toggle('active', tab === 'tasks');

            if (tab === 'schedule') {
                loadSchedule();
            } else {
                loadTasks();
            }
        };

        async function loadSchedule() {
            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);

                const semesters = [];
                snapshot.forEach(doc => {
                    semesters.push({ id: doc.id, ...doc.data() });
                });

                const currentSemester = semesters.find(s => s.type === 'current');
                const courses = currentSemester?.courses || [];

                const scheduleContent = document.getElementById('schedule-content');

                if (courses.length === 0) {
                    scheduleContent.innerHTML = `
                        <div class="empty-container">
                            <ion-icon name="calendar-outline" size="large" style="font-size: 64px; color: #666;"></ion-icon>
                            <p class="empty-text">No current semester found or no courses added.</p>
                        </div>
                    `;
                    showLoading(false);
                    return;
                }

                const hasAnySchedule = courses.some(c => (c.schedules && c.schedules.length > 0) || c.schedule);

                if (!hasAnySchedule) {
                    scheduleContent.innerHTML = `
                        <div class="empty-container">
                            <ion-icon name="calendar-outline" size="large" style="font-size: 64px; color: #666;"></ion-icon>
                            <p class="empty-text">No schedule details added yet.<br>Tap + to add class times.</p>
                        </div>
                    `;
                    showLoading(false);
                    return;
                }

                // Group by day
                let html = '';
                const today = DAYS[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1];
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                DAYS.forEach(day => {
                    let dayItems = [];
                    courses.forEach(c => {
                        const schedules = c.schedules || (c.schedule ? [c.schedule] : []);
                        schedules.forEach(s => {
                            if (s.day === day) {
                                dayItems.push({ ...c, activeSchedule: s });
                            }
                        });
                    });

                    // Sort by time
                    dayItems.sort((a, b) => (a.activeSchedule?.startTime || '').localeCompare(b.activeSchedule?.startTime || ''));

                    // Special sorting for Today: Future first, then Past
                    if (day === today) {
                        const future = dayItems.filter(c => c.activeSchedule.endTime > currentTime);
                        const past = dayItems.filter(c => c.activeSchedule.endTime <= currentTime);
                        dayItems = [...future, ...past];
                    }

                    if (dayItems.length > 0) {
                        html += `
                            <div class="day-section">
                                <div class="day-title" style="${day === today ? 'color: var(--primary-color); font-weight: 900;' : ''}">${day === today ? day + ' (Today)' : day}</div>
                                ${dayItems.map(item => {
                            const isPast = day === today && item.activeSchedule.endTime <= currentTime;
                            return `
                                    <div class="schedule-card" style="${isPast ? 'opacity: 0.5; order: 1;' : ''}">
                                        <div class="time-container">
                                            <div class="time-text">${item.activeSchedule.startTime}</div>
                                            <div class="time-line"></div>
                                            <div class="time-text" style="color: #999;">${item.activeSchedule.endTime}</div>
                                        </div>
                                        <div class="details-container">
                                            <div class="course-code">${item.code}</div>
                                            <div class="course-name">${item.name}</div>
                                            ${item.activeSchedule.venue ? `
                                                <div class="venue-container">
                                                    <ion-icon name="location-outline" style="font-size: 14px; color: #999;"></ion-icon>
                                                    <span class="venue-text">${item.activeSchedule.venue}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 8px; margin-left: auto;">
                                            <button onclick="openEditScheduleModal('${item.activeSchedule.id || item.id}', '${item.id}', '${item.activeSchedule.day}', '${item.activeSchedule.startTime}', '${item.name}', 'true', '', '${item.activeSchedule.endTime}', '${item.activeSchedule.venue || ''}'); event.stopPropagation();" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                                <ion-icon name="create-outline" style="font-size: 20px; color: var(--primary-color);"></ion-icon>
                                            </button>
                                            <button onclick="deleteScheduleItem('${item.activeSchedule.id || item.id}', 'course', '${item.id}'); event.stopPropagation();" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                                <ion-icon name="trash-outline" style="color: #dc3545; font-size: 20px;"></ion-icon>
                                            </button>
                                        </div>
                                    </div>
                                `;
                        }).join('')}
                            </div>
                        `;
                    }
                });

                scheduleContent.innerHTML = html;

            } catch (error) {
                console.error('Load schedule error:', error);
                showToast('Error loading schedule', 'error');
                document.getElementById('schedule-content').innerHTML = `
                    <div class="empty-container">
                        <p class="empty-text">Error loading schedule. Please try again.</p>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        async function loadTasks() {
            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                // CHANGED: Use root 'tasks' collection to match mobile
                const tasksRef = collection(db, 'tasks');
                const q = query(tasksRef, where('userId', '==', uid));
                const snapshot = await getDocs(q);

                allTasks = [];
                snapshot.forEach(doc => {
                    allTasks.push({ id: doc.id, ...doc.data() });
                });

                // Sort by due date
                allTasks.sort((a, b) => a.dueDate - b.dueDate);

                const tasksContent = document.getElementById('tasks-content');

                if (allTasks.length === 0) {
                    tasksContent.innerHTML = `
                        <div class="empty-container">
                            <ion-icon name="checkbox-outline" size="large" style="font-size: 64px; color: #666;"></ion-icon>
                            <p class="empty-text">No tasks yet. Tap + to add one!</p>
                        </div>
                    `;
                    return;
                }

                const html = allTasks.map(task => `
                    <div class="task-card" style="${task.isCompleted ? 'opacity: 0.5;' : ''}">
                        <button class="checkbox" onclick="toggleTask('${task.id}', ${task.isCompleted})">
                            <ion-icon 
                                name="${task.isCompleted ? 'checkmark-circle' : 'ellipse-outline'}" 
                                style="font-size: 24px; color: ${task.isCompleted ? '#667eea' : '#999'};">
                            </ion-icon>
                        </button>
                        <div class="task-content">
                            <div class="task-title" style="${task.isCompleted ? 'text-decoration: line-through;' : ''}">${task.title}</div>
                            <div class="task-meta">
                                ${task.courseName ? `<span class="task-course">${task.courseName} • </span>` : ''}
                                <span class="task-date">Due: ${new Date(task.dueDate).toLocaleDateString()}</span>
                            </div>
                        </div>
                         <div style="display: flex; gap: 8px;">
                            <button class="delete-task-button" onclick="editTask('${task.id}')" style="color: #667eea;" ${task.isCompleted ? 'disabled' : ''}>
                                <ion-icon name="create-outline" style="font-size: 20px;"></ion-icon>
                            </button>
                            <button class="delete-task-button" onclick="deleteTaskItem('${task.id}')">
                                <ion-icon name="trash-outline" style="font-size: 20px; color: #dc3545;"></ion-icon>
                            </button>
                        </div>
                    </div>
                `).join('');

                tasksContent.innerHTML = html;

            } catch (error) {
                console.error('Load tasks error:', error);
                showToast('Error loading tasks', 'error');
                document.getElementById('tasks-content').innerHTML = `
                    <div class="empty-container">
                        <p class="empty-text">Error loading tasks. Please try again.</p>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        window.toggleScheduleDateInput = function () {
            const isRecurring = document.getElementById('schedule-recurring').checked;
            if (isRecurring) {
                document.getElementById('schedule-day-container').classList.remove('hidden');
                document.getElementById('schedule-date-container').classList.add('hidden');
            } else {
                document.getElementById('schedule-day-container').classList.add('hidden');
                document.getElementById('schedule-date-container').classList.remove('hidden');
            }
        };

        window.showAddScheduleModal = async function () {
            // Reset form
            document.getElementById('schedule-title').value = '';
            document.getElementById('schedule-recurring').checked = true;
            toggleScheduleDateInput();

            document.getElementById('edit-schedule-id').value = '';
            document.getElementById('edit-schedule-course-id').value = '';
            document.getElementById('edit-schedule-original-start').value = '';

            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);

                const semesters = [];
                snapshot.forEach(doc => {
                    semesters.push({ id: doc.id, ...doc.data() });
                });

                const currentSemester = semesters.find(s => s.type === 'current');
                const courses = currentSemester?.courses || [];

                const select = document.getElementById('schedule-course-select');
                let options = '<option value="">No Course / Personal</option>';

                if (courses.length > 0) {
                    options += courses.map(c => `<option value="${c.id}">${c.code} - ${c.name}</option>`).join('');
                }

                select.innerHTML = options;

                document.getElementById('add-schedule-modal').classList.add('show');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error loading courses', 'error');
            }
        };

        window.saveSchedule = async function () {
            const courseId = document.getElementById('schedule-course-select').value;
            const day = document.getElementById('schedule-day').value;
            const startTime = document.getElementById('schedule-start-time').value;
            const endTime = document.getElementById('schedule-end-time').value;
            const venue = document.getElementById('schedule-venue').value;

            if (!courseId) {
                showToast('Please select a course', 'error');
                return;
            }

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);

                let currentSemester = null;
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (data.type === 'current') {
                        currentSemester = data;
                    }
                });

                if (!currentSemester) {
                    showToast('No current semester found', 'error');
                    showLoading(false);
                    return;
                }

                const courseIndex = currentSemester.courses.findIndex(c => c.id === courseId);
                if (courseIndex === -1) {
                    showToast('Course not found', 'error');
                    showLoading(false);
                    return;
                }

                const newSchedule = {
                    day,
                    startTime,
                    endTime,
                    venue: venue || undefined
                };

                const existingSchedules = currentSemester.courses[courseIndex].schedules || (currentSemester.courses[courseIndex].schedule ? [currentSemester.courses[courseIndex].schedule] : []) || [];

                // Avoid duplicates
                const isDuplicate = existingSchedules.some(s => s.day === newSchedule.day && s.startTime === newSchedule.startTime);
                if (isDuplicate) {
                    showToast('Class time already exists', 'error');
                    showLoading(false);
                    return;
                }

                const updatedSchedules = [...existingSchedules, newSchedule];
                currentSemester.courses[courseIndex].schedules = updatedSchedules;
                currentSemester.courses[courseIndex].schedule = newSchedule; // Sync legacy

                await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                    courses: currentSemester.courses
                });

                showToast('Schedule added!', 'success');
                closeModal('add-schedule-modal');
                loadSchedule();

            } catch (error) {
                console.error('Save schedule error:', error);
                showToast('Error saving schedule', 'error');
            }

            showLoading(false);
        };

        window.deleteScheduleItem = async function (courseId, day, startTime) {
            if (!confirm('Delete this class time?')) return;

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                // Find course in current semester
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);
                let currentSemester = null;
                snapshot.forEach(doc => {
                    if (doc.data().type === 'current') currentSemester = { id: doc.id, ...doc.data() };
                });

                if (currentSemester) {
                    const courses = currentSemester.courses;
                    const idx = courses.findIndex(c => c.id === courseId);
                    if (idx !== -1) {
                        let schedules = courses[idx].schedules || (courses[idx].schedule ? [courses[idx].schedule] : []) || [];

                        // Filter out specific schedule
                        if (day && startTime) {
                            schedules = schedules.filter(s => s.day !== day || s.startTime !== startTime);
                        } else {
                            schedules = [];
                        }

                        courses[idx].schedules = schedules;
                        courses[idx].schedule = schedules.length > 0 ? schedules[0] : null;

                        await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                            courses
                        });
                        showToast('Class cancelled', 'success');
                        loadSchedule();
                    }
                }
            } catch (e) {
                console.error(e);
                showToast('Error removing schedule', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.showAddTaskModal = async function () {
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);

                const semesters = [];
                snapshot.forEach(doc => {
                    semesters.push({ id: doc.id, ...doc.data() });
                });

                const currentSemester = semesters.find(s => s.type === 'current');
                const courses = currentSemester?.courses || [];

                const select = document.getElementById('task-course-select');
                select.innerHTML = '<option value="">None</option>' +
                    courses.map(c => `<option value="${c.id}">${c.code} - ${c.name}</option>`).join('');

                document.getElementById('task-id').value = ''; // Reset ID
                // Set default due date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('task-due-date').value = tomorrow.toISOString().split('T')[0];
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';

                document.getElementById('add-task-modal').classList.add('show');
            } catch (error) {
                console.error('Error:', error);
            }
        };

        window.editTask = async function (taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;

            await window.showAddTaskModal();

            document.getElementById('task-id').value = taskId;
            document.getElementById('task-title').value = task.title;
            document.getElementById('task-course-select').value = task.courseId || '';
            document.getElementById('task-type').value = task.type || 'assignment';
            document.getElementById('task-due-date').value = new Date(task.dueDate).toISOString().split('T')[0];
            document.getElementById('task-description').value = task.description || '';

            document.querySelector('#add-task-modal h2').textContent = 'Edit Task';
        };

        window.addTask = async function () {
            const title = document.getElementById('task-title').value.trim();
            const courseId = document.getElementById('task-course-select').value;
            const type = document.getElementById('task-type').value;
            const dueDate = document.getElementById('task-due-date').value;
            const description = document.getElementById('task-description').value.trim();

            if (!title || !dueDate) {
                showToast('Please enter title and due date', 'error');
                return;
            }

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                // Get course name if selected
                // Get course name if selected
                let courseName = null;
                if (courseId) {
                    const semRef = collection(db, 'users', uid, 'semesters');
                    const snapshot = await getDocs(semRef);

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.type === 'current') {
                            const course = data.courses?.find(c => c.id === courseId);
                            if (course) {
                                courseName = course.name;
                            }
                        }
                    });
                }

                const taskId = document.getElementById('task-id').value;

                const taskData = {
                    title,
                    courseId: courseId || null,
                    courseName: courseName || null,
                    type,
                    dueDate: new Date(dueDate).getTime(),
                    description: description || null
                };

                if (taskId) {
                    // Update
                    console.log('Updating task:', taskId);
                    await updateDoc(doc(db, 'tasks', taskId), taskData);
                    showToast('Task updated!', 'success');
                } else {
                    // Create
                    const taskRef = doc(collection(db, 'tasks'));
                    console.log('Creating new task:', taskRef.id);
                    await setDoc(taskRef, {
                        id: taskRef.id,
                        userId: uid,
                        ...taskData,
                        isCompleted: false,
                        createdAt: Date.now()
                    });
                    showToast('Task added!', 'success');
                }

                closeModal('add-task-modal');
                document.getElementById('task-id').value = '';
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                loadTasks();

            } catch (error) {
                console.error('Task error:', error);
                showToast('Error saving task', 'error');
            }

            showLoading(false);
        };

        window.toggleTask = async function (taskId, currentStatus) {
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                await updateDoc(doc(db, 'tasks', taskId), {
                    isCompleted: !currentStatus
                });

                loadTasks();
            } catch (error) {
                console.error('Toggle task error:', error);
                showToast('Error updating task', 'error');
            }
        };

        window.deleteTaskItem = async function (taskId) {
            if (!confirm('Delete this task?')) return;

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                await deleteDoc(doc(db, 'tasks', taskId));
                showToast('Task deleted', 'success');
                loadTasks();
            } catch (error) {
                console.error('Delete task error:', error);
                showToast('Error deleting task', 'error');
            }

            showLoading(false);
        };


        // USER SEARCH & PROFILE FUNCTIONS
        let allUsers = [];

        window.showUserFriends = async function (userId) {
            showLoading(true);
            try {
                const friendsRef = collection(db, 'friends');
                const q = query(friendsRef, where('userId', '==', userId));
                const snapshot = await getDocs(q);

                const friendIds = [];
                snapshot.forEach(doc => friendIds.push(doc.data().friendId));

                const friends = [];
                for (const fid of friendIds) {
                    const docSnap = await getDoc(doc(db, 'users', fid));
                    if (docSnap.exists()) friends.push({ id: docSnap.id, ...docSnap.data() });
                }

                const modal = document.getElementById('user-search-modal');
                if (modal.querySelector('h2')) modal.querySelector('h2').textContent = 'Friends';
                renderUsers(friends);
                modal.classList.add('show');
            } catch (e) {
                console.error(e);
                showToast('Error loading friends', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.showUserSearch = async function () {
            const modal = document.getElementById('user-search-modal');
            if (modal.querySelector('h2')) modal.querySelector('h2').textContent = 'Find Users';
            modal.classList.add('show');
            document.getElementById('user-search-input').focus();
            await loadAllUsers();
        };

        async function loadAllUsers() {
            showLoading(true);
            try {
                const usersRef = collection(db, 'users');
                const snapshot = await getDocs(usersRef);

                allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });

                renderUsers(allUsers);
            } catch (error) {
                console.error('Load users error:', error);
                showToast('Error loading users', 'error');
            } finally {
                showLoading(false);
            }
        }

        window.searchUsers = function () {
            const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
            const filtered = allUsers.filter(u =>
                u.username?.toLowerCase().includes(searchTerm) ||
                u.email?.toLowerCase().includes(searchTerm)
            );
            renderUsers(filtered);
        };

        function renderUsers(users) {
            const uid = localStorage.getItem('kobi_atlas_uid');
            const html = users.length > 0 ? users.map(user => {
                if (user.id === uid) return ''; // Don't show current user

                const isOnline = user.lastActive && (Date.now() - user.lastActive < 300000); // 5 min

                return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #2a2a2a; border-radius: 8px; margin-bottom: 10px; cursor: pointer;" onclick="viewUserProfile('${user.id}')">
                        <div style="position: relative;">
                            ${user.profilePicture ?
                        `<img src="${user.profilePicture}" style="width: 50px; height: 50px; border-radius: 25px; object-fit: cover;">` :
                        `<div style="width: 50px; height: 50px; border-radius: 25px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px;">${user.username?.[0]?.toUpperCase() || 'U'}</div>`
                    }
                            ${isOnline ? '<div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: #4CAF50; border: 2px solid #1a1a1a; border-radius: 50%;"></div>' : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold;">${user.username || 'Anonymous'}</div>
                            <div style="font-size: 12px; color: #999;">${user.email || ''}</div>
                        </div>
                        <ion-icon name="chevron-forward" style="color: #999;"></ion-icon>
                    </div>
                `;
            }).join('') : '<p style="text-align: center; color: #999; padding: 20px;">No users found</p>';

            document.getElementById('users-list').innerHTML = html;
        }

        window.viewUserProfile = async function (userId) {
            showLoading(true);
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) {
                    showToast('User not found', 'error');
                    return;
                }

                currentViewingUser = { id: userDoc.id, ...userDoc.data() };
                const uid = localStorage.getItem('kobi_atlas_uid');
                const isOwnProfile = userId === uid;

                // Check friend status
                const friendsRef = collection(db, 'friends');
                const q1 = query(friendsRef, where('userId', '==', uid), where('friendId', '==', userId));
                const q2 = query(friendsRef, where('userId', '==', userId), where('friendId', '==', uid));
                const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);

                const isFriend = !snap1.empty || !snap2.empty;

                // Check pending request
                const requestsRef = collection(db, 'friendRequests');
                const q3 = query(requestsRef, where('fromUserId', '==', uid), where('toUserId', '==', userId), where('status', '==', 'pending'));
                const snap3 = await getDocs(q3);
                const hasPendingRequest = !snap3.empty;

                // Get user's posts (Filter locally to avoid Index requirements)
                const postsRef = collection(db, 'posts');
                const postsQuery = query(postsRef, where('authorId', '==', userId));
                const postsSnap = await getDocs(postsQuery);
                const userPosts = [];
                postsSnap.forEach(doc => userPosts.push({ id: doc.id, ...doc.data() }));

                // Sort by timestamp desc
                userPosts.sort((a, b) => b.timestamp - a.timestamp);

                const joinDate = currentViewingUser.createdAt ? new Date(currentViewingUser.createdAt).toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) : 'Unknown';
                const lastSeen = currentViewingUser.lastActive ? formatTime(currentViewingUser.lastActive) : 'Never';
                const isOnline = currentViewingUser.lastActive && (Date.now() - currentViewingUser.lastActive < 300000);
                const friendCount = currentViewingUser.friends?.length || 0;

                const html = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        ${currentViewingUser.profilePicture ?
                        `<img src="${currentViewingUser.profilePicture}" style="width: 100px; height: 100px; border-radius: 50px; object-fit: cover; margin-bottom: 10px;">` :
                        `<div style="width: 100px; height: 100px; border-radius: 50px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 40px; margin: 0 auto 10px;">${currentViewingUser.username?.[0]?.toUpperCase() || 'U'}</div>`
                    }
                        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <h2 style="margin: 10px 0;">${currentViewingUser.username || 'Anonymous'}</h2>
                            ${isOwner(currentViewingUser) ? '<ion-icon name="shield-checkmark" style="color: #FFD700; font-size: 20px;"></ion-icon>' : ''}
                        </div>
                        <p style="color: #999;">${currentViewingUser.email || ''}</p>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 12px; background: #2a2a2a; border-radius: 8px;">
                            <div style="font-size: 20px; font-weight: bold;">${userPosts.length}</div>
                            <div style="font-size: 12px; color: #999;">Posts</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #2a2a2a; border-radius: 8px; cursor: pointer;" onclick="showUserFriends('${currentViewingUser.id}')">
                            <div style="font-size: 20px; font-weight: bold;">${friendCount}</div>
                            <div style="font-size: 12px; color: #999;">Friends</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: #2a2a2a; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: bold; color: ${isOnline ? '#4CAF50' : '#999'};">${lastSeen}</div>
                            <div style="font-size: 12px; color: #999;">Last Seen</div>
                        </div>
                    </div>

                    <!-- Achievements -->
                    <div style="padding: 16px; background: #2a2a2a; border-radius: 8px; margin-bottom: 16px;">
                        <h3 style="margin: 0 0 12px 0;">Achievements</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${ACHIEVEMENTS.map(ach => {
                        const isUnlocked = currentViewingUser.achievements && currentViewingUser.achievements.includes(ach.id);
                        return `
                                    <div style="width: calc(33.33% - 6px); text-align: center; opacity: ${isUnlocked ? 1 : 0.3};">
                                        <div style="width: 40px; height: 40px; border-radius: 20px; background: ${isUnlocked ? 'var(--primary-color)' : '#444'}; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px;">
                                            <ion-icon name="${ach.icon}" style="color: white; font-size: 20px;"></ion-icon>
                                        </div>
                                        <div style="font-size: 10px; color: var(--text-color);">${ach.title}</div>
                                    </div>
                                `;
                    }).join('')}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    ${!isOwnProfile ? `
                        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                            ${isFriend ? `
                                <button class="btn btn-primary" style="flex: 1;" onclick="openChat('${userId}')">
                                    <ion-icon name="chatbubble" style="margin-right: 6px;"></ion-icon>
                                    Message
                                </button>
                                <button class="btn btn-secondary" onclick="unfriend('${userId}')">Unfriend</button>
                            ` : hasPendingRequest ? `
                                <button class="btn btn-primary" style="flex: 1;" onclick="openChat('${userId}')">
                                    <ion-icon name="chatbubble" style="margin-right: 6px;"></ion-icon>
                                    Message
                                </button>
                                <button class="btn btn-secondary" style="flex: 1;" disabled>Request Sent</button>
                            ` : `
                                <button class="btn btn-primary" style="flex: 1;" onclick="openChat('${userId}')">
                                    <ion-icon name="chatbubble" style="margin-right: 6px;"></ion-icon>
                                    Message
                                </button>
                                <button class="btn btn-secondary" style="flex: 1;" onclick="sendFriendRequest('${userId}')">
                                    <ion-icon name="person-add" style="margin-right: 6px;"></ion-icon>
                                    Add Friend
                                </button>
                            `}
                        </div>
                    ` : ''}
                    
                    <!-- About Me -->
                    ${currentViewingUser.bio || currentViewingUser.aboutMe ? `
                        <div style="padding: 16px; background: #2a2a2a; border-radius: 8px; margin-bottom: 16px;">
                            <h3 style="margin: 0 0 10px 0;">About Me</h3>
                            <p style="margin: 0; color: #ccc; line-height: 1.5;">${currentViewingUser.bio || currentViewingUser.aboutMe}</p>
                        </div>
                    ` : ''}
                    
                    <!-- Information -->
                    <div style="padding: 16px; background: #2a2a2a; border-radius: 8px; margin-bottom: 16px;">
                        <h3 style="margin: 0 0 12px 0;">Information</h3>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <ion-icon name="mail-outline" style="color: #999;"></ion-icon>
                            <span style="color: #999;">${currentViewingUser.email || 'No email'}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <ion-icon name="calendar-outline" style="color: #999;"></ion-icon>
                            <span style="color: #999;">Joined ${joinDate}</span>
                        </div>
                    </div>
                    
                    <!-- Recent Posts -->
                    <div style="padding: 16px; background: #2a2a2a; border-radius: 8px;">
                        <h3 style="margin: 0 0 12px 0;">Recent Posts (${userPosts.length})</h3>
                        ${userPosts.length > 0 ? userPosts.slice(0, 5).map(post => `
                            <div style="padding: 12px; background: #1a1a1a; border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="closeModal('user-profile-modal'); openPostDetail('${post.id}')">
                                <p style="margin: 0 0 8px 0; line-height: 1.4;">${(post.contentText || 'No text').substring(0, 100)}${(post.contentText || '').length > 100 ? '...' : ''}</p>
                                <div style="display: flex; gap: 16px; font-size: 12px; color: #999;">
                                    <span><ion-icon name="heart"></ion-icon> ${post.likes?.length || 0}</span>
                                    <span><ion-icon name="chatbubble"></ion-icon> ${post.replies?.length || 0}</span>
                                    <span>${formatTime(post.timestamp)}</span>
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; color: #999; padding: 20px;">No posts yet</p>'}
                    </div>
                `;

                document.getElementById('user-profile-content').innerHTML = html;
                closeModal('user-search-modal');
                document.getElementById('user-profile-modal').classList.add('show');

            } catch (error) {
                console.error('View profile error:', error);
                showToast('Error loading profile', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.sendFriendRequest = async function (toUserId) {
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.data() || {};

                const requestRef = doc(collection(db, 'friendRequests'));
                await setDoc(requestRef, {
                    id: requestRef.id,
                    fromUserId: uid,
                    toUserId: toUserId,
                    fromUsername: userData.username || userData.displayName || 'Anonymous',
                    fromProfilePicture: userData.profilePicture || null,
                    status: 'pending',
                    timestamp: Date.now()
                });

                showToast('Friend request sent!', 'success');
                viewUserProfile(toUserId); // Refresh profile
            } catch (error) {
                console.error('Send friend request error:', error);
                showToast('Error sending request', 'error');
            }
        };

        window.unfriend = async function (friendId) {
            if (!confirm('Remove this friend?')) return;

            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const friendsRef = collection(db, 'friends');
                const q1 = query(friendsRef, where('userId', '==', uid), where('friendId', '==', friendId));
                const q2 = query(friendsRef, where('userId', '==', friendId), where('friendId', '==', uid));

                const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);

                const deletePromises = [];
                snap1.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                snap2.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));

                await Promise.all(deletePromises);

                showToast('Friend removed', 'success');
                viewUserProfile(friendId); // Refresh profile
            } catch (error) {
                console.error('Unfriend error:', error);
                showToast('Error removing friend', 'error');
            }
        };

        // NOTIFICATIONS FUNCTIONS
        window.showNotifications = async function () {
            document.getElementById('notifications-modal').classList.add('show');
            await loadNotifications();
        };

        async function loadNotifications() {
            showLoading(true);
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                // Get generic notifications
                const notifRef = collection(db, 'notifications');
                const notifQuery = query(notifRef, where('userId', '==', uid), where('read', '==', false));
                const notifSnapshot = await getDocs(notifQuery);

                const genericNotifications = [];
                for (const docSnap of notifSnapshot.docs) {
                    const data = docSnap.data();
                    let extraData = {};

                    // If it's a "friend_accepted" notification, fetch the user who accepted
                    if (data.type === 'friend_accepted' && data.fromUserId) {
                        try {
                            const userDoc = await getDoc(doc(db, 'users', data.fromUserId));
                            if (userDoc.exists()) {
                                const uData = userDoc.data();
                                extraData = {
                                    username: uData.username || 'Someone',
                                    profilePicture: uData.profilePicture
                                };
                            }
                        } catch (e) {
                            console.error('Error fetching user for notification', e);
                        }
                    }

                    genericNotifications.push({
                        id: docSnap.id,
                        type: data.type || 'generic',
                        fromUserId: data.fromUserId,
                        timestamp: data.timestamp || Date.now(),
                        message: data.message || 'New notification',
                        referenceId: data.referenceId, // postId, replyId etc.
                        ...extraData
                    });
                }

                // Get friend requests
                const requestsRef = collection(db, 'friendRequests');
                const q = query(requestsRef, where('toUserId', '==', uid), where('status', '==', 'pending'));
                const snapshot = await getDocs(q);

                const friendRequests = [];
                for (const docSnap of snapshot.docs) {
                    const data = docSnap.data();

                    // Fetch the actual user data to avoid "undefined"
                    const userDoc = await getDoc(doc(db, 'users', data.fromUserId));
                    if (!userDoc.exists()) continue;

                    const userData = userDoc.data();
                    friendRequests.push({
                        id: docSnap.id,
                        type: 'friend_request',
                        fromUserId: data.fromUserId,
                        fromUsername: userData.username || userData.displayName || 'Anonymous',
                        fromProfilePicture: userData.profilePicture || null,
                        timestamp: data.timestamp
                    });
                }

                // Merge and sort
                const notifications = [...friendRequests, ...genericNotifications];
                notifications.sort((a, b) => b.timestamp - a.timestamp);

                const html = notifications.length > 0 ? notifications.map(notif => {
                    if (notif.type === 'friend_request') {
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #2a2a2a; border-radius: 8px; margin-bottom: 10px;">
                                <div style="cursor: pointer;" onclick="viewUserProfile('${notif.fromUserId}')">
                                    ${notif.fromProfilePicture ?
                                `<img src="${notif.fromProfilePicture}" style="width: 40px; height: 40px; border-radius: 20px; object-fit: cover;">` :
                                `<div style="width: 40px; height: 40px; border-radius: 20px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${notif.fromUsername?.[0]?.toUpperCase() || 'U'}</div>`
                            }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; cursor: pointer;" onclick="viewUserProfile('${notif.fromUserId}')">${notif.fromUsername}</div>
                                    <div style="font-size: 12px; color: #999;">sent you a friend request</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px; width: auto;" onclick="acceptFriendRequest('${notif.id}', '${notif.fromUserId}')">Accept</button>
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; width: auto;" onclick="rejectFriendRequest('${notif.id}')">Reject</button>
                                </div>
                            </div>
                        `;
                    } else if (notif.type === 'friend_accepted') {
                        // Friend accepted notification
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #2a2a2a; border-radius: 8px; margin-bottom: 10px;">
                                <div style="cursor: pointer;" onclick="viewUserProfile('${notif.fromUserId}')">
                                    ${notif.profilePicture ?
                                `<img src="${notif.profilePicture}" style="width: 40px; height: 40px; border-radius: 20px; object-fit: cover;">` :
                                `<div style="width: 40px; height: 40px; border-radius: 20px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${notif.username?.[0]?.toUpperCase() || 'U'}</div>`
                            }
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px;"><strong>${notif.username || 'Someone'}</strong> accepted your friend request</div>
                                    <div style="font-size: 10px; color: #999; margin-top: 4px;">${formatTime(notif.timestamp)}</div>
                                </div>
                                <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 10px; width: auto; min-width: 60px;" onclick="markNotificationRead('${notif.id}')">Dismiss</button>
                            </div>
                        `;
                    } else {
                        // Generic notification
                        return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #2a2a2a; border-radius: 8px; margin-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px;">${notif.message}</div>
                                    <div style="font-size: 10px; color: #999; margin-top: 4px;">${formatTime(notif.timestamp)}</div>
                                </div>
                                <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 10px; width: auto; min-width: 60px;" onclick="markNotificationRead('${notif.id}')">Dismiss</button>
                            </div>
                        `;
                    }
                }).join('') : '<p style="text-align: center; color: #999; padding: 20px;">No notifications</p>';

                document.getElementById('notifications-list').innerHTML = html;

                // Update badge
                const badge = document.getElementById('notification-badge');
                if (notifications.length > 0) {
                    badge.textContent = notifications.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

            } catch (error) {
                console.error('Load notifications error:', error);
                showToast('Error loading notifications', 'error');
            } finally {
                showLoading(false);
            }
        }
        window.markNotificationRead = async function (notifId) {
            try {
                await updateDoc(doc(db, 'notifications', notifId), { read: true });
                loadNotifications(); // Reload list
                loadUnreadCounts(); // Update badges
            } catch (error) {
                console.error('Error marking read:', error);
            }
        };

        window.acceptFriendRequest = async function (requestId, fromUserId) {
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                // Get sender data first for the notification
                const userDoc = await getDoc(doc(db, 'users', fromUserId));
                const userData = userDoc.data() || {};

                // Create friend relationship (both ways)
                const friend1Ref = doc(collection(db, 'friends'));
                await setDoc(friend1Ref, {
                    userId: uid,
                    friendId: fromUserId,
                    timestamp: Date.now()
                });

                const friend2Ref = doc(collection(db, 'friends'));
                await setDoc(friend2Ref, {
                    userId: fromUserId,
                    friendId: uid,
                    timestamp: Date.now()
                });

                // Update request status
                await updateDoc(doc(db, 'friendRequests', requestId), {
                    status: 'accepted'
                });

                // Create a notification for the sender (fromUserId)
                const notificationRef = doc(collection(db, 'notifications'));
                await setDoc(notificationRef, {
                    id: notificationRef.id,
                    userId: fromUserId, // The user receiving the notification
                    fromUserId: uid, // The user who accepted the request (current user)
                    type: 'friend_accepted',
                    message: `${localStorage.getItem('kobi_atlas_username') || 'Someone'} accepted your friend request`,
                    read: false,
                    timestamp: Date.now()
                });

                showToast('Friend request accepted!', 'success');
                loadNotifications();
            } catch (error) {
                console.error('Accept request error:', error);
                showToast('Error accepting request', 'error');
            }
        };

        window.rejectFriendRequest = async function (requestId) {
            try {
                await updateDoc(doc(db, 'friendRequests', requestId), {
                    status: 'rejected'
                });

                showToast('Friend request rejected', 'success');
                loadNotifications();
            } catch (error) {
                console.error('Reject request error:', error);
                showToast('Error rejecting request', 'error');
            }
        };

        // MESSAGES FUNCTIONS
        window.showMessages = async function () {
            document.getElementById('messages-modal').classList.add('show');
            await loadConversations();
        };

        async function loadConversations() {
            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const messagesRef = collection(db, 'messages');

                // Get all messages where user is sender or receiver (NO FRIENDS REQUIREMENT!)
                const q1 = query(messagesRef, where('senderId', '==', uid));
                const q2 = query(messagesRef, where('receiverId', '==', uid));

                const [snapshot1, snapshot2] = await Promise.all([getDocs(q1), getDocs(q2)]);

                // Collect all unique user IDs and messages by user
                const userIds = new Set();
                const messagesByUser = new Map();

                snapshot1.forEach(doc => {
                    const data = doc.data();
                    if (data.deleted) return; // Skip deleted

                    userIds.add(data.receiverId);
                    if (!messagesByUser.has(data.receiverId)) {
                        messagesByUser.set(data.receiverId, []);
                    }
                    messagesByUser.get(data.receiverId).push(data);
                });

                snapshot2.forEach(doc => {
                    const data = doc.data();
                    if (data.deleted) return; // Skip deleted

                    userIds.add(data.senderId);
                    if (!messagesByUser.has(data.senderId)) {
                        messagesByUser.set(data.senderId, []);
                    }
                    messagesByUser.get(data.senderId).push(data);
                });

                // Fetch user details and create conversations
                const conversations = [];

                for (const userId of userIds) {
                    const userDoc = await getDoc(doc(db, 'users', userId));
                    if (!userDoc.exists()) continue; // Skip deleted users

                    const userData = userDoc.data();
                    const userMessages = messagesByUser.get(userId) || [];

                    // Sort by timestamp descending
                    userMessages.sort((a, b) => b.timestamp - a.timestamp);

                    const lastMsg = userMessages[0];
                    const unread = userMessages.filter(msg => msg.senderId != uid && (msg.read !== true && msg.read !== 'true')).length;

                    conversations.push({
                        friendId: userId,
                        username: userData.username || 'Anonymous',
                        profilePicture: userData.profilePicture,
                        lastMessage: lastMsg?.text || 'No messages yet',
                        timestamp: lastMsg?.timestamp || 0,
                        unreadCount: unread,
                        isOnline: userData.lastActive && (Date.now() - userData.lastActive < 300000)
                    });
                }

                console.log('Loaded conversations:', conversations.length);
                const unreadMessages = conversations.filter(c => c.unreadCount > 0);
                const readMessages = conversations.filter(c => c.unreadCount === 0);

                let html = '';

                if (conversations.length === 0) {
                    html = `
                    <div style="text-align: center; padding: 60px 20px;">
                            <ion-icon name="chatbubbles-outline" style="font-size: 64px; color: #666;"></ion-icon>
                            <p style="font-size: 20px; font-weight: 600; margin: 16px 0 8px 0;">No messages found.</p>
                            <p style="font-size: 14px; color: #999; margin-bottom: 24px;">Start a conversation by searching for users</p>
                            <button class="btn btn-primary" onclick="showUserSearch()">Find Users</button>
                        </div>
                    `;
                } else {
                    if (unreadMessages.length > 0) {
                        html += `
                            <div style="padding: 8px 12px; margin-bottom: 8px; color: var(--primary-color); font-weight: bold; font-size: 12px; text-transform: uppercase;">Unread (${unreadMessages.length})</div>
                        `;
                        html += unreadMessages.map(conv => renderConversationItem(conv)).join('');
                    }

                    if (readMessages.length > 0) {
                        html += `
                            <div style="padding: 8px 12px; margin-top: 16px; margin-bottom: 8px; color: #999; font-weight: bold; font-size: 12px; text-transform: uppercase;">Read Messages</div>
                        `;
                        html += readMessages.map(conv => renderConversationItem(conv)).join('');
                    }
                }

                document.getElementById('conversations-list').innerHTML = html;

            } catch (error) {
                console.error('Load conversations error:', error);
                showToast('Error loading conversations', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderConversationItem(conv) {
            return `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${conv.unreadCount > 0 ? 'rgba(102, 126, 234, 0.15)' : '#2a2a2a'}; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: ${conv.unreadCount > 0 ? '2px solid var(--primary-color)' : '1px solid rgba(0,0,0,0.05)'}; position: relative;" onclick="openChat('${conv.friendId}')">
                                ${conv.unreadCount > 0 ? `
                            <div style="position: absolute; left: 4px; top: 50%; margin-top: -4px; width: 8px; height: 8px; border-radius: 4px; background: var(--primary-color);"></div>
                        ` : ''
                }
                        <div style="position: relative;">
                            ${conv.profilePicture ?
                    `<img src="${conv.profilePicture}" style="width: 50px; height: 50px; border-radius: 25px; object-fit: cover;">` :
                    `<div style="width: 50px; height: 50px; border-radius: 25px; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px;">${conv.username?.[0]?.toUpperCase() || 'U'}</div>`
                }
                            ${conv.isOnline ? '<div style="position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px; border-radius: 7px; background: #4CAF50; border: 2px solid #1a1a1a;"></div>' : ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <div style="font-weight: ${conv.unreadCount > 0 ? '900' : '600'}; font-size: 16px;">${conv.username}</div>
                                <div style="font-size: 12px; color: ${conv.unreadCount > 0 ? 'var(--primary-color)' : '#999'}; font-weight: ${conv.unreadCount > 0 ? 'bold' : 'normal'};">${conv.timestamp ? formatTime(conv.timestamp) : ''}</div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 14px; color: ${conv.unreadCount > 0 ? '#fff' : '#999'}; ${conv.unreadCount > 0 ? 'font-weight: 700;' : ''} flex: 1;">${conv.lastMessage.substring(0, 50)}${conv.lastMessage.length > 50 ? '...' : ''}</div>
                                ${conv.unreadCount > 0 ? `
                                    <div style="min-width: 20px; height: 20px; border-radius: 10px; background: #007AFF; display: flex; align-items: center; justify-content: center; padding: 0 6px; margin-left: 8px;">
                                        <span style="color: white; font-size: 11px; font-weight: bold;">${conv.unreadCount}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    `;
        }

        window.openChat = async function (friendId) {
            showLoading(true);
            try {
                const friendDoc = await getDoc(doc(db, 'users', friendId));
                const friendData = friendDoc.data() || {};

                currentChatUser = { id: friendId, ...friendData };

                document.getElementById('chat-username').textContent = friendData.username || 'Chat';

                closeModal('user-profile-modal');
                closeModal('messages-modal');
                document.getElementById('chat-modal').classList.add('show');

                await loadMessages(friendId);
            } catch (error) {
                console.error('Open chat error:', error);
                showToast('Error opening chat', 'error');
            } finally {
                showLoading(false);
            }
        };

        async function loadMessages(friendId) {
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const messagesRef = collection(db, 'messages');
                const q1 = query(messagesRef, where('senderId', '==', uid), where('receiverId', '==', friendId));
                const q2 = query(messagesRef, where('senderId', '==', friendId), where('receiverId', '==', uid));

                const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);

                const messages = [];
                snap1.forEach(doc => {
                    const data = doc.data();
                    if (!data.deleted) {
                        messages.push({ id: doc.id, ...data });
                    }
                });
                snap2.forEach(doc => {
                    const data = doc.data();
                    if (!data.deleted) {
                        messages.push({ id: doc.id, ...data });
                    }
                });

                messages.sort((a, b) => a.timestamp - b.timestamp);

                const html = messages.length > 0 ? messages.map(msg => {
                    const isMine = msg.senderId === uid;
                    return `
                    <div style="display: flex; justify-content: ${isMine ? 'flex-end' : 'flex-start'}; margin-bottom: 10px;">
                        <div style="max-width: 70%; padding: 10px 14px; background: ${isMine ? '#667eea' : '#2a2a2a'}; border-radius: 12px; ${isMine ? 'border-bottom-right-radius: 4px;' : 'border-bottom-left-radius: 4px;'}">
                            <div>${msg.text}</div>
                            <div style="font-size: 10px; color: ${isMine ? 'rgba(255,255,255,0.7)' : '#999'}; margin-top: 4px;">${formatTime(msg.timestamp)}</div>
                        </div>
                    </div>
                    `;
                }).join('') : '<p style="text-align: center; color: #999; padding: 20px;">No messages yet. Say hi!</p>';

                document.getElementById('messages-list').innerHTML = html;
                document.getElementById('messages-list').scrollTop = document.getElementById('messages-list').scrollHeight;

            } catch (error) {
                console.error('Load messages error:', error);
            }
        }

        window.sendMessage = async function () {
            const text = document.getElementById('message-input').value.trim();
            if (!text || !currentChatUser) return;

            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const messagesRef = collection(db, 'messages');
                await addDoc(messagesRef, {
                    senderId: uid,
                    receiverId: currentChatUser.id,
                    text: text,
                    timestamp: Date.now(),
                    read: false
                });

                document.getElementById('message-input').value = '';
                await loadMessages(currentChatUser.id);

            } catch (error) {
                console.error('Send message error:', error);
                showToast('Error sending message', 'error');
            }
        };

        // PROFILE SETTINGS FUNCTIONS
        window.showProfileSettings = function () {
            document.getElementById('settings-modal').classList.add('show');
        };

        window.showEditProfile = async function () {
            const uid = localStorage.getItem('kobi_atlas_uid');

            try {
                const userDoc = await getDoc(doc(db, 'users', uid));
                const userData = userDoc.data() || {};

                document.getElementById('profile-username').value = userData.username || '';
                document.getElementById('profile-bio').value = userData.bio || '';

                if (userData.profilePicture) {
                    document.getElementById('profile-picture-preview').src = userData.profilePicture;
                    document.getElementById('profile-picture-preview').style.display = 'block';
                    // Don't set uploadedImageBase64 - only set it when user selects NEW image
                }


                document.getElementById('profile-settings-modal').classList.add('show');
            } catch (error) {
                console.error('Load profile settings error:', error);
                showToast('Error loading profile', 'error');
            }
        };

        window.saveProfile = async function () {
            const uid = localStorage.getItem('kobi_atlas_uid');
            const username = document.getElementById('profile-username').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();

            if (!username) {
                showToast('Username is required', 'error');
                return;
            }

            try {
                // DEFINITIVE FIX: Manual, brute-force re-compression
                const fileInput = document.getElementById('profile-picture-input');
                let finalProfilePicture = null; // Default to null - don't update if no new image

                if (fileInput && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    console.log('Starting BRUTE-FORCE compression for:', file.name);

                    try {
                        finalProfilePicture = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = new Image();
                                img.onload = () => {
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    const maxSize = 400; // User demanded 400x400

                                    if (width > height) {
                                        if (width > maxSize) {
                                            height *= maxSize / width;
                                            width = maxSize;
                                        }
                                    } else {
                                        if (height > maxSize) {
                                            width *= maxSize / height;
                                            height = maxSize;
                                        }
                                    }

                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);

                                    // 0.5 quality is a good balance
                                    resolve(canvas.toDataURL('image/jpeg', 0.5));
                                };
                                img.onerror = () => reject(new Error('Image load failed'));
                                img.src = e.target.result;
                            };
                            reader.onerror = () => reject(new Error('File read failed'));
                            reader.readAsDataURL(file);
                        });
                        console.log('Final compressed size:', finalProfilePicture.length);
                    } catch (compError) {
                        console.error('Compression failed:', compError);
                        showToast('Failed to compress image', 'error');
                        return;
                    }
                } else if (uploadedImageBase64) {
                    // User didn't select new image, but uploadedImageBase64 was set from preview
                    // Use it only if it's already small (from handleImageUpload compression)
                    finalProfilePicture = uploadedImageBase64;
                }


                // FAIL SAFE: If image is still too large (>800KB), ABORT SAVE
                if (finalProfilePicture && finalProfilePicture.length > 800000) {
                    showToast('Image cannot be compressed enough. Please use a smaller image.', 'error');
                    console.error('ABORTING SAVE: Image size ' + finalProfilePicture.length + ' is over limit');
                    return;
                }

                const userRef = doc(db, 'users', uid);
                const updateData = {
                    username: username,
                    bio: bio,
                    lastActive: Date.now()
                };

                // Only update profile picture if a new one was selected
                if (finalProfilePicture !== null) {
                    updateData.profilePicture = finalProfilePicture;
                }

                await updateDoc(userRef, updateData);


                showToast('Profile updated!', 'success');
                closeModal('profile-settings-modal');
                uploadedImageBase64 = null;

            } catch (error) {
                console.error('Save profile error:', error);
                if (error.message && (error.message.includes('longer than') || error.message.includes('too large'))) {
                    showToast('The file size is too large', 'error');
                } else {
                    showToast('Error saving profile', 'error');
                }
            }
        };

        // LOGOUT FUNCTION
        window.logout = function () {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('kobi_atlas_uid');
                localStorage.removeItem('kobi_atlas_pin');
                window.location.reload();
            }
        };

        // CHANGE PIN - Now handled by dedicated change-pin.html page

        window.saveScheduleV2 = async function () {
            const courseId = document.getElementById('schedule-course-select').value;
            const title = document.getElementById('schedule-title').value.trim();
            const isRecurring = document.getElementById('schedule-recurring').checked;

            // Edit checks
            const isEdit = document.getElementById('edit-schedule-id').value !== '';

            // Validation - either course OR title must be filled
            if (!courseId && !title) {
                showToast('Please select a course or enter a title', 'error');
                return;
            }


            const startTime = document.getElementById('schedule-start-time').value;
            const endTime = document.getElementById('schedule-end-time').value;
            const venue = document.getElementById('schedule-venue').value;

            if (!startTime || !endTime) {
                showToast('Please set times', 'error');
                return;
            }

            let day = '';
            let date = '';

            if (isRecurring) {
                day = document.getElementById('schedule-day').value;
                if (!day) return;
            } else {
                date = document.getElementById('schedule-date').value;
                if (!date) {
                    showToast('Please select a date', 'error');
                    return;
                }
                const d = new Date(date);
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                day = days[d.getDay()];
            }

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);

                let currentSemester = null;
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (data.type === 'current') {
                        currentSemester = data;
                    }
                });

                if (!currentSemester) {
                    showToast('No current semester found', 'error');
                    showLoading(false);
                    return;
                }

                // Handle switching courses/types (Delete old reference if changed)
                const originalId = document.getElementById('edit-schedule-id').value;
                const originalCourseId = document.getElementById('edit-schedule-course-id').value;

                if (isEdit && (originalCourseId !== courseId)) {
                    // Course changed, delete from original location first
                    if (originalCourseId) {
                        // Was in a course
                        const oldCourseIndex = currentSemester.courses.findIndex(c => c.id === originalCourseId);
                        if (oldCourseIndex !== -1) {
                            let oldSchedules = currentSemester.courses[oldCourseIndex].schedules || [];
                            // Remove the schedule with originalId
                            const updatedOldSchedules = oldSchedules.filter(s => s.id !== originalId);
                            currentSemester.courses[oldCourseIndex].schedules = updatedOldSchedules;
                            if (currentSemester.courses[oldCourseIndex].schedule && currentSemester.courses[oldCourseIndex].schedule.id === originalId) {
                                currentSemester.courses[oldCourseIndex].schedule = updatedOldSchedules[0] || null;
                            }
                        }
                    } else {
                        // Was custom event
                        let customEvents = currentSemester.customEvents || [];
                        currentSemester.customEvents = customEvents.filter(e => e.id !== originalId);
                    }
                    // We don't save yet, we simply modified the local object 'currentSemester'
                    // The save below will persist everything (since we update the whole courses/customEvents arrays)
                    // Actually, we must ensure we save BOTH changes if we split the update calls.
                    // Better strategy: Update the local 'currentSemester' object completely, then save once if possible,
                    // or just rely on the existing update calls but make sure we didn't miss the cleanup.

                    // Since this function does specific updateDoc calls for courses/customEvents, 
                    // we should perform the cleanup updateDoc HERE if we want to be safe, or merge logic.

                    // Let's do the cleanup update first to ensure consistency
                    if (originalCourseId) {
                        // Clean up old course
                        await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                            courses: currentSemester.courses
                        });
                    } else {
                        // Clean up custom events
                        await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                            customEvents: currentSemester.customEvents || []
                        });
                    }
                }


                // PROCEED TO SAVE NEW/UPDATED ENTRY (in new location)

                const newScheduleItem = {
                    id: isEdit ? originalId : Date.now().toString(),
                    title: courseId ? '' : title,
                    isRecurring,
                    day,
                    date: isRecurring ? null : date,
                    startTime,
                    endTime,
                    venue: venue || null
                };


                // COURSE Event
                if (courseId) {
                    const courses = currentSemester.courses;
                    const idx = courses.findIndex(c => c.id === courseId);
                    if (idx === -1) {
                        showToast('Course not found', 'error');
                        showLoading(false);
                        return;
                    }

                    let schedules = courses[idx].schedules || (courses[idx].schedule ? [courses[idx].schedule] : []) || [];

                    // If editing AND same course (or we just moved it here), we treat as update/add
                    // If we moved it here, it's effectively a "new" add to this course, but keeping ID

                    // Check if ID exists in this course
                    const existingIdx = schedules.findIndex(s => s.id === newScheduleItem.id);

                    if (existingIdx !== -1) {
                        // Update existing in this course
                        schedules[existingIdx] = newScheduleItem;
                    } else {
                        // New to this course (Add)
                        // Check conflicts
                        if (schedules.some(s => s.day === newScheduleItem.day && s.startTime === newScheduleItem.startTime)) {
                            showToast('Time slot occupied', 'error');
                            showLoading(false);
                            return;
                        }
                        schedules.push(newScheduleItem);
                    }

                    courses[idx].schedules = schedules;
                    if (schedules.length > 0) courses[idx].schedule = schedules[0]; // legacy sync

                    await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                        courses: currentSemester.courses
                    });
                }
                // CUSTOM Event
                else {
                    let customEvents = currentSemester.customEvents || [];
                    const existingIdx = customEvents.findIndex(e => e.id === newScheduleItem.id);

                    if (existingIdx !== -1) {
                        customEvents[existingIdx] = newScheduleItem;
                    } else {
                        customEvents.push(newScheduleItem);
                    }

                    await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                        customEvents: customEvents
                    });
                }

                showToast('Schedule saved!', 'success');
                closeModal('add-schedule-modal');
                if (window.loadSchedule) window.loadSchedule();
                if (window.loadDashboard) window.loadDashboard();

            } catch (error) {
                console.error('Save schedule error:', error);
                showToast('Error saving schedule', 'error');
            } finally {
                showLoading(false);
            }
        };

        // --- OVERRIDES AND NEW FUNCTIONS ---

        window.loadSchedule = async function () {
            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);

                const semesters = [];
                snapshot.forEach(doc => {
                    semesters.push({ id: doc.id, ...doc.data() });
                });

                const currentSemester = semesters.find(s => s.type === 'current');
                const courses = currentSemester?.courses || [];
                const customEvents = currentSemester?.customEvents || [];

                const scheduleContent = document.getElementById('schedule-content');

                const hasAnySchedule = courses.some(c => (c.schedules && c.schedules.length > 0) || c.schedule) || customEvents.length > 0;

                if (!hasAnySchedule) {
                    scheduleContent.innerHTML = `
                        <div class="empty-container">
                            <ion-icon name="calendar-outline" size="large" style="font-size: 64px; color: #666;"></ion-icon>
                            <p class="empty-text">No schedule details added yet.<br>Tap + to add class times or events.</p>
                        </div>
                    `;
                    showLoading(false);
                    return;
                }

                // Group by day
                let html = '';
                const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const today = DAYS[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1];
                const now = new Date();
                const nowTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                const todayDateStr = now.toISOString().split('T')[0];

                DAYS.forEach(day => {
                    let dayItems = [];

                    // 1. Course Schedules
                    courses.forEach(c => {
                        const schedules = c.schedules || (c.schedule ? [c.schedule] : []);
                        schedules.forEach(s => {
                            if (s.day === day) {
                                dayItems.push({
                                    type: 'course',
                                    title: c.name,
                                    subtitle: c.code,
                                    isRecurring: true, // Course events default to recurring
                                    ...s,
                                    courseId: c.id
                                });
                            }
                        });
                    });

                    // 2. Custom Events
                    customEvents.forEach(e => {
                        let eventDay = e.day;
                        if (!e.isRecurring && e.date) { // One-time event
                            const d = new Date(e.date);
                            const eventDayIndex = d.getDay();
                            eventDay = DAYS[eventDayIndex === 0 ? 6 : eventDayIndex - 1];
                        }

                        if (eventDay === day) {
                            dayItems.push({
                                type: 'custom',
                                title: e.title,
                                subtitle: 'Personal Event',
                                ...e,
                                courseId: ''
                            });
                        }
                    });

                    // Sort by time
                    dayItems.sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));

                    if (dayItems.length > 0) {
                        html += `
                            <div class="day-section">
                                <div class="day-title" style="${day === today ? 'color: var(--primary-color); font-weight: 900;' : ''}">${day === today ? day + ' (Today)' : day}</div>
                                ${dayItems.map(item => {
                            let isDimmed = false;
                            // Grey out if one-time and passed date
                            if (!item.isRecurring) {
                                if (item.date < todayDateStr) isDimmed = true;
                                else if (item.date === todayDateStr && item.endTime <= nowTime) isDimmed = true;
                            }

                            const editArgs = `'${item.id}', '${item.courseId || ''}', '${item.day || ''}', '${item.startTime}', '${item.title.replace(/'/g, "\\'")}', '${item.isRecurring}', '${item.date || ''}', '${item.endTime}', '${item.venue || ''}'`;

                            return `
                                    <div class="schedule-card" style="${isDimmed ? 'opacity: 0.5; order: 1;' : ''}">
                                        <div class="time-container">
                                            <div class="time-text">${item.startTime}</div>
                                            <div class="time-line"></div>
                                            <div class="time-text" style="color: #999;">${item.endTime}</div>
                                        </div>
                                        <div class="details-container">
                                            <div class="course-code">${item.subtitle || ''}</div>
                                            <div class="course-name">
                                                ${item.title}
                                                ${item.isRecurring ? '<ion-icon name="refresh" style="font-size: 12px; margin-left: 4px; color: #999;"></ion-icon>' : ''}
                                            </div>
                                            ${item.venue ? `
                                                <div class="venue-container">
                                                    <ion-icon name="location-outline" style="font-size: 14px; color: #999;"></ion-icon>
                                                    <span class="venue-text">${item.venue}</span>
                                                </div>
                                            ` : ''}
                                            ${!item.isRecurring && item.date ? `<div style="font-size: 10px; color: #666; margin-top: 2px;">${new Date(item.date).toLocaleDateString()}</div>` : ''}
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 8px; margin-left: 10px;">
                                            <button onclick="openEditScheduleModal(${editArgs}); event.stopPropagation();" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                                <ion-icon name="create-outline" style="font-size: 20px; color: var(--primary-color);"></ion-icon>
                                            </button>
                                            <button onclick="deleteScheduleItem('${item.id}', '${item.type}', '${item.courseId || ''}'); event.stopPropagation();" style="background: none; border: none; cursor: pointer; padding: 4px;">
                                                <ion-icon name="trash-outline" style="font-size: 20px; color: #dc3545;"></ion-icon>
                                            </button>
                                        </div>
                                    </div>
                                `;
                        }).join('')}
                            </div>
                        `;
                    }
                });

                scheduleContent.innerHTML = html || '<div class="empty-container"><p class="empty-text">No schedule found.</p></div>';

            } catch (error) {
                console.error('Load schedule error:', error);

            } finally {
                showLoading(false);
            }
        };

        window.openEditScheduleModal = function (id, courseId, day, startTime, title, isRecurring, date, endTime, venue) {
            document.getElementById('add-schedule-modal').classList.add('show');
            const isRec = (String(isRecurring) === 'true');

            document.getElementById('schedule-course-select').value = courseId || '';
            document.getElementById('schedule-title').value = title || '';
            document.getElementById('schedule-recurring').checked = isRec;

            if (isRec) {
                document.getElementById('schedule-day-container').classList.remove('hidden');
                document.getElementById('schedule-date-container').classList.add('hidden');
                if (day && day !== 'undefined' && day !== 'null') document.getElementById('schedule-day').value = day;
            } else {
                document.getElementById('schedule-day-container').classList.add('hidden');
                document.getElementById('schedule-date-container').classList.remove('hidden');
            }

            document.getElementById('schedule-start-time').value = startTime;
            document.getElementById('schedule-end-time').value = endTime || '';
            document.getElementById('schedule-venue').value = venue || '';
            if (date && date !== 'undefined' && date !== 'null') document.getElementById('schedule-date').value = date;

            document.getElementById('edit-schedule-id').value = id;
            document.getElementById('edit-schedule-course-id').value = courseId || '';
        };

        window.deleteScheduleItem = async function (itemId, itemType, courseId) {
            if (!confirm('Delete this schedule item?')) return;

            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);

            try {
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);
                let currentSemester = null;

                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (data.type === 'current') {
                        currentSemester = data;
                    }
                });

                if (!currentSemester) {
                    showToast('No current semester found', 'error');
                    showLoading(false);
                    return;
                }

                if (itemType === 'course' && courseId) {
                    // Delete from course schedules
                    const courses = currentSemester.courses;
                    const courseIndex = courses.findIndex(c => c.id === courseId);

                    if (courseIndex !== -1) {
                        let schedules = courses[courseIndex].schedules || [];
                        schedules = schedules.filter(s => s.id !== itemId);
                        courses[courseIndex].schedules = schedules;

                        await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                            courses: courses
                        });
                    }
                } else {
                    // Delete from custom events
                    let customEvents = currentSemester.customEvents || [];
                    customEvents = customEvents.filter(e => e.id !== itemId);

                    await updateDoc(doc(db, 'users', uid, 'semesters', currentSemester.id), {
                        customEvents: customEvents
                    });
                }

                showToast('Schedule deleted', 'success');
                if (window.loadSchedule) window.loadSchedule();

            } catch (error) {
                console.error('Delete schedule error:', error);
                showToast('Error deleting schedule', 'error');
            } finally {
                showLoading(false);
            }
        };

        window.loadDashboardWidgets = async function () {
            const container = document.getElementById('dashboard-widgets');
            if (!container) return;

            const uid = localStorage.getItem('kobi_atlas_uid');
            const now = new Date();
            const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const today = DAYS[now.getDay()];
            const nowTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const todayDate = now.toISOString().split('T')[0];

            let nextEvent = null;
            let nextTask = null;

            try {
                // 1. Get Next Event (Today)
                const semRef = collection(db, 'users', uid, 'semesters');
                const snapshot = await getDocs(semRef);
                let currentSemester = null;
                snapshot.forEach(doc => { if (doc.data().type === 'current') currentSemester = doc.data(); });

                if (currentSemester) {
                    const candidates = [];
                    // Courses
                    (currentSemester.courses || []).forEach(c => {
                        (c.schedules || (c.schedule ? [c.schedule] : [])).forEach(s => {
                            if (s.day === today && s.startTime > nowTime) {
                                candidates.push({ ...s, title: c.name + ' (' + c.code + ')' });
                            }
                        });
                    });
                    // Custom
                    (currentSemester.customEvents || []).forEach(e => {
                        let isToday = false;
                        if (e.isRecurring && e.day === today) isToday = true;
                        if (!e.isRecurring && e.date === todayDate) isToday = true;

                        if (isToday && e.startTime > nowTime) {
                            candidates.push(e);
                        }
                    });

                    if (candidates.length > 0) {
                        candidates.sort((a, b) => a.startTime.localeCompare(b.startTime));
                        nextEvent = candidates[0];
                    }
                }

                // 2. Get Next Task
                const tasksRef = collection(db, 'users', uid, 'tasks');
                const taskSnap = await getDocs(query(tasksRef, where('isCompleted', '==', false)));
                let tasks = [];
                taskSnap.forEach(d => tasks.push(d.data()));

                tasks = tasks.filter(t => {
                    let dStr = '';
                    if (typeof t.dueDate === 'number') dStr = new Date(t.dueDate).toISOString().split('T')[0];
                    else dStr = t.dueDate;
                    return dStr >= todayDate;
                });

                tasks.sort((a, b) => {
                    let da = typeof a.dueDate === 'number' ? a.dueDate : new Date(a.dueDate).getTime();
                    let db = typeof b.dueDate === 'number' ? b.dueDate : new Date(b.dueDate).getTime();
                    return da - db;
                });

                if (tasks.length > 0) nextTask = tasks[0];

                // Render
                let html = '';
                if (nextEvent) {
                    html += `<div style="margin-bottom: 4px;">Next Event: <strong>${nextEvent.startTime} - ${nextEvent.title}</strong></div>`;
                }

                if (nextTask) {
                    let dDisplay = '';
                    if (typeof nextTask.dueDate === 'number') dDisplay = new Date(nextTask.dueDate).toLocaleDateString();
                    else dDisplay = nextTask.dueDate;
                    html += `<div>Next Task: <strong>${nextTask.title}</strong> (${dDisplay})</div>`;
                }

                container.innerHTML = html;

            } catch (e) { console.error('Widget error', e); }
        };

        window.showEndSemesterModal = async function (semesterId) {
            const uid = localStorage.getItem('kobi_atlas_uid');
            showLoading(true);
            try {
                // If a specific ID is provided, fetch it. Otherwise fallback to current (legacy support if needed)
                let currentSemester = null;

                if (semesterId) {
                    const docSnap = await getDoc(doc(db, 'users', uid, 'semesters', semesterId));
                    if (docSnap.exists()) {
                        currentSemester = { id: docSnap.id, ...docSnap.data() };
                    }
                } else {
                    const semRef = collection(db, 'users', uid, 'semesters');
                    const snapshot = await getDocs(semRef);
                    snapshot.forEach(doc => { if (doc.data().type === 'current') currentSemester = { id: doc.id, ...doc.data() }; });
                }

                if (!currentSemester) {
                    showToast('No active semester to end', 'error');
                    showLoading(false);
                    return;
                }

                // Build Modal HTML
                let html = `
                    <h3 style="margin-bottom: 15px;">Complete Semester: ${currentSemester.name}</h3>
                    
                    <!-- Input Mode Toggle -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; background: #2a2a2a; border-radius: 8px; padding: 4px;">
                        <button type="button" id="score-mode-btn" class="btn btn-primary" onclick="setEndSemesterInputMode('score')" style="flex: 1; padding: 8px; font-size: 12px;">Enter Scores</button>
                        <button type="button" id="grade-mode-btn" class="btn btn-secondary" onclick="setEndSemesterInputMode('grade')" style="flex: 1; padding: 8px; font-size: 12px;">Enter Grades</button>
                    </div>
                    
                    <p id="input-mode-description" style="margin-bottom: 20px; color: #666;">Enter your final scores (0-100) for each course to calculate your GPA.</p>
                    <form id="end-semester-form">
                `;

                currentSemester.courses.forEach(course => {
                    html += `
                        <div class="form-group">
                            <label>${course.code} - ${course.name}</label>
                            <div id="score-input-${course.id}" class="score-input-container">
                                <input type="number" class="course-score-input" data-id="${course.id}" placeholder="Score (0-100)" min="0" max="100">
                            </div>
                            <div id="grade-input-${course.id}" class="grade-input-container" style="display: none;">
                                <div style="display: flex; gap: 8px;">
                                    ${['A', 'B', 'C', 'D', 'E', 'F'].map(grade => `
                                        <button type="button" class="grade-btn" data-course-id="${course.id}" data-grade="${grade}" onclick="selectGrade('${course.id}', '${grade}')" style="flex: 1; padding: 10px; border: 1px solid #444; background: #1a1a1a; color: #fff; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                            ${grade}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeModal('generated-modal')" style="flex: 1;">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="confirmEndSemester('${currentSemester.id}')" style="flex: 1;">Complete Semester</button>
                        </div>
                    </form>
                `;

                // Show in a generic modal container (assuming one exists or reusing 'resource-upload-modal' by clearing it, or creating one)
                // Let's create a dynamic modal div if it doesn't exist
                let modal = document.getElementById('generated-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'generated-modal';
                    modal.className = 'modal';
                    modal.innerHTML = '<div class="modal-content"><div id="generated-modal-body"></div></div>';
                    document.body.appendChild(modal);
                }
                document.getElementById('generated-modal-body').innerHTML = html;
                modal.classList.add('show');

            } catch (e) { console.error(e); }
            finally { showLoading(false); }
        };

        // End Semester Input Mode Management
        let endSemesterInputMode = 'score';
        const selectedGrades = {};

        window.setEndSemesterInputMode = function (mode) {
            endSemesterInputMode = mode;

            // Update button styles
            const scoreBtn = document.getElementById('score-mode-btn');
            const gradeBtn = document.getElementById('grade-mode-btn');

            if (scoreBtn && gradeBtn) {
                if (mode === 'score') {
                    scoreBtn.classList.remove('btn-secondary');
                    scoreBtn.classList.add('btn-primary');
                    gradeBtn.classList.remove('btn-primary');
                    gradeBtn.classList.add('btn-secondary');
                } else {
                    gradeBtn.classList.remove('btn-secondary');
                    gradeBtn.classList.add('btn-primary');
                    scoreBtn.classList.remove('btn-primary');
                    scoreBtn.classList.add('btn-secondary');
                }
            }

            // Update description
            const description = document.getElementById('input-mode-description');
            if (description) {
                description.textContent = mode === 'score'
                    ? 'Enter your final scores (0-100) for each course to calculate your GPA.'
                    : 'Select letter grades (A-F) for each course.';
            }

            // Toggle input containers
            const scoreContainers = document.querySelectorAll('.score-input-container');
            const gradeContainers = document.querySelectorAll('.grade-input-container');

            scoreContainers.forEach(container => {
                container.style.display = mode === 'score' ? 'block' : 'none';
            });

            gradeContainers.forEach(container => {
                container.style.display = mode === 'grade' ? 'block' : 'none';
            });
        };

        window.selectGrade = function (courseId, grade) {
            selectedGrades[courseId] = grade;

            // Update button styles
            const buttons = document.querySelectorAll(`[data-course-id="${courseId}"]`);
            buttons.forEach(btn => {
                if (btn.dataset.grade === grade) {
                    btn.style.background = '#667eea';
                    btn.style.borderColor = '#667eea';
                } else {
                    btn.style.background = '#1a1a1a';
                    btn.style.borderColor = '#444';
                }
            });
        };

        window.confirmEndSemester = async function (semId) {
            const uid = localStorage.getItem('kobi_atlas_uid');
            const scores = {};

            // Collect data based on input mode
            if (endSemesterInputMode === 'score') {
                const inputs = document.querySelectorAll('.course-score-input');
                for (let input of inputs) {
                    if (!input.value) {
                        showToast('Please enter all scores', 'error');
                        return;
                    }
                    if (input.value < 0 || input.value > 100) {
                        showToast('Scores must be 0-100', 'error');
                        return;
                    }
                    scores[input.dataset.id] = parseInt(input.value);
                }
            } else {
                // Grade mode - check selectedGrades
                const semDocRef = doc(db, 'users', uid, 'semesters', semId);
                const semDoc = await getDoc(semDocRef);
                const semester = semDoc.data();

                for (let course of semester.courses) {
                    if (!selectedGrades[course.id]) {
                        showToast('Please select a grade for all courses', 'error');
                        return;
                    }
                    scores[course.id] = selectedGrades[course.id];
                }
            }

            showLoading(true);
            try {
                // Fetch again to ensure fresh data
                const semDocRef = doc(db, 'users', uid, 'semesters', semId);
                const semDoc = await getDoc(semDocRef);
                const semester = semDoc.data();

                // Calculate Grades
                let totalPoints = 0;
                let totalUnits = 0;

                semester.courses = semester.courses.map(c => {
                    let grade = 'F';
                    let points = 0;
                    let finalScore;

                    if (endSemesterInputMode === 'score') {
                        const score = scores[c.id];
                        finalScore = score;

                        if (score >= 70) { grade = 'A'; points = 5; }
                        else if (score >= 60) { grade = 'B'; points = 4; }
                        else if (score >= 50) { grade = 'C'; points = 3; }
                        else if (score >= 45) { grade = 'D'; points = 2; }
                        else if (score >= 40) { grade = 'E'; points = 1; }
                    } else {
                        // Grade mode
                        grade = scores[c.id];

                        if (grade === 'A') points = 5;
                        else if (grade === 'B') points = 4;
                        else if (grade === 'C') points = 3;
                        else if (grade === 'D') points = 2;
                        else if (grade === 'E') points = 1;
                        else points = 0;
                    }

                    totalPoints += (points * c.unitHours);
                    totalUnits += c.unitHours;

                    return { ...c, finalScore, grade: grade };
                });

                const gpa = totalUnits > 0 ? (totalPoints / totalUnits).toFixed(2) : 0.0;

                await updateDoc(semDocRef, {
                    courses: semester.courses,
                    gpa: parseFloat(gpa),
                    type: 'past'
                });

                closeModal('generated-modal');
                showToast('Semester completed! GPA: ' + gpa, 'success');
                window.loadDashboard();

            } catch (e) {
                console.error(e);
                showToast('Error completing semester', 'error');
            } finally {
                showLoading(false);
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const uid = localStorage.getItem('kobi_atlas_uid');
            const email = localStorage.getItem('kobi_atlas_email');

            if (uid && email) {
                // User is logged in, load dashboard
                loadDashboard();
            } else {
                // Not logged in, redirect to login page
                window.location.href = 'index.html';
            }
        });
    </script>
    <!-- Resource Upload Modal -->
    <div id="resource-upload-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share Resource</h3>
                <button class="close-btn" onclick="closeModal('resource-upload-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Course Code</label>
                    <input type="text" id="res-course-code" placeholder="e.g. CSC 201">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="res-title" placeholder="e.g. 2023 Past Question">
                </div>
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="res-desc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Resource Type</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button type="button" class="btn btn-primary" id="res-type-link"
                            onclick="setResourceType('link')" style="flex: 1;">Link</button>
                        <button type="button" class="btn btn-secondary" id="res-type-image"
                            onclick="setResourceType('image')" style="flex: 1;">Image</button>
                        <button type="button" class="btn btn-secondary" id="res-type-file"
                            onclick="setResourceType('file')" style="flex: 1;">File</button>
                    </div>
                </div>

                <div class="form-group" id="res-link-container">
                    <label>Link (URL)</label>
                    <input type="url" id="res-link" placeholder="https://...">
                </div>

                <div class="form-group hidden" id="res-image-container">
                    <label>Upload Image</label>
                    <input type="file" id="res-image-file" accept="image/*" onchange="handleResourceImageSelect(event)">
                    <img id="res-image-preview"
                        style="max-width: 100%; margin-top: 10px; display: none; border-radius: 8px;">
                </div>

                <div class="form-group hidden" id="res-file-container">
                    <label>Upload File</label>
                    <input type="file" id="res-file-input" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
                        onchange="handleResourceFileSelect(event)">
                    <div id="res-file-info" style="margin-top: 10px; font-size: 14px; color: #999;"></div>
                </div>

                <button class="btn btn-primary" onclick="uploadResource()"
                    style="width: 100%; margin-top: 10px;">Upload</button>
            </div>
        </div>
    </div>


    <!-- Image Lightbox Modal -->
    <div id="image-lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <div class="lightbox-controls">
            <button onclick="event.stopPropagation(); zoomIn();" title="Zoom In">+</button>
            <button onclick="event.stopPropagation(); zoomOut();" title="Zoom Out">-</button>
            <button onclick="event.stopPropagation(); resetZoom();" title="Reset Zoom">⟲</button>
        </div>
        <img id="lightbox-image" class="lightbox-content" onclick="event.stopPropagation()">
    </div>

    <style>
        .lightbox {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
        }

        .lightbox.show {
            display: flex;
        }

        .lightbox-content {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 50px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .lightbox-close:hover {
            color: #bbb;
        }

        .lightbox-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10001;
        }

        .lightbox-controls button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            color: #333;
            font-size: 24px;
            font-weight: bold;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .lightbox-controls button:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        .lightbox-content {
            transition: transform 0.3s ease;
            cursor: move;
            user-select: none;
        }
    </style>

    <script>
        // Zoom functionality
        let currentZoom = 1;

        function openLightbox(imageSrc) {
            currentZoom = 1; // Reset zoom when opening
            document.getElementById('lightbox-image').src = imageSrc;
            document.getElementById('image-lightbox').classList.add('show');
            applyZoom();
        }

        function closeLightbox() {
            document.getElementById('image-lightbox').classList.remove('show');
            currentZoom = 1;
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.25, 3);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.25, 0.5);
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
        }

        function applyZoom() {
            const img = document.getElementById('lightbox-image');
            img.style.transform = `scale(${currentZoom})`;
        }

        // Mouse wheel zoom
        document.addEventListener('DOMContentLoaded', function () {
            const lightboxImage = document.getElementById('lightbox-image');
            lightboxImage.addEventListener('wheel', function (e) {
                if (document.getElementById('image-lightbox').classList.contains('show')) {
                    e.preventDefault();
                    if (e.deltaY < 0) {
                        zoomIn();
                    } else {
                        zoomOut();
                    }
                }
            });
        });

        // Close on Escape key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                closeLightbox();
            }
        });
    </script>
</body>

</html>